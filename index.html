<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jogo do Juiz ‚Äî Vale Produ√ß√£o</title>

  <!-- React 18 + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root { height: 100%; }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    /* Scroll suave */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(148,163,184,0.6) transparent;
    }
    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,0.6);
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // -------------------- DADOS FIXOS --------------------
    const ESTADOS = {
      "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
      "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
      "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
      "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
      "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
      "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
      "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
      "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
      "RO":["Porto Velho"],"RR":["Boa Vista"],
      "SC":["Florian√≥polis","Joinville"],
      "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
      "SE":["Aracaju"],"TO":["Palmas"]
    };

    const SOUND_URLS = {
      gavel: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
      murmur: "https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
    };

    function useSound(url, enabled = true, volume = 0.7) {
      const ref = useRef(null);
      useEffect(() => {
        const a = new Audio(url);
        a.volume = volume;
        ref.current = a;
        return () => {
          a.pause();
          ref.current = null;
        };
      }, [url]);
      const play = () => {
        if (enabled && ref.current) {
          ref.current.currentTime = 0;
          ref.current.play();
        }
      };
      return { play };
    }

    function useTypewriter(text, speed = 20) {
      const [out, setOut] = useState("");
      useEffect(() => {
        if (!text) { setOut(""); return; }
        let i = 0;
        setOut("");
        const id = setInterval(() => {
          i++;
          setOut(text.slice(0, i));
          if (i >= text.length) clearInterval(id);
        }, speed);
        return () => clearInterval(id);
      }, [text, speed]);
      return out;
    }

    // -------------------- GERA√á√ÉO DE CASOS --------------------
    function seedCases() {
      const casos = [];
      let idNum = 1;

      function addLote(tipo, tituloBase, resumoBase, culpado, qtd, dificuldade) {
        for (let i = 0; i < qtd; i++) {
          const num = idNum++;
          casos.push({
            id: tipo + "-" + num,
            tipo,
            dificuldade,
            titulo: `${tituloBase} #${i+1}`,
            resumo: resumoBase,
            gabarito: { culpado },
            status: "na_fila",
            provas: [
              {
                id: "E1",
                tipo: "boletim",
                conteudo: "Boletim de ocorr√™ncia com narrativa inicial dos fatos, hor√°rio e local."
              },
              {
                id: "E2",
                tipo: "laudo",
                conteudo: "Laudo t√©cnico (pericial ou m√©dico) descrevendo consequ√™ncias materiais ou f√≠sicas."
              },
              {
                id: "E3",
                tipo: "testemunha",
                conteudo: "Depoimento de testemunha, com pontos de converg√™ncia e diverg√™ncia entre as vers√µes."
              },
              {
                id: "E4",
                tipo: "documento",
                conteudo: "Documentos complementares (prints, contratos, imagens de c√¢mera, registros de ponto)."
              }
            ]
          });
        }
      }

      // Criminal - diferentes tipos e dificuldades
      addLote("criminal",
        "Homic√≠dio simples em briga de bar",
        "Discuss√£o em estabelecimento que evolui para agress√µes sucessivas, culminando em morte de uma das partes.",
        true, 20, "alta"
      );
      addLote("criminal",
        "Roubo majorado em via p√∫blica",
        "Subtra√ß√£o de bens com emprego de arma (ou simulacro) e grave amea√ßa, seguido de fuga em ve√≠culo.",
        true, 20, "m√©dia"
      );
      addLote("criminal",
        "Les√£o corporal em contexto dom√©stico",
        "Conflito entre parceiros √≠ntimos com relatos de agress√µes anteriores e medida protetiva em curso.",
        true, 20, "alta"
      );
      addLote("criminal",
        "Tr√°fico e uso de entorpecentes",
        "Apreens√£o de subst√¢ncias il√≠citas em quantidades variadas, discuss√£o sobre destina√ß√£o para uso ou com√©rcio.",
        true, 20, "m√©dia"
      );
      addLote("criminal",
        "Furto qualificado tentado",
        "Tentativa de subtra√ß√£o de bens com rompimento de obst√°culo, interrompida pela chegada da pol√≠cia.",
        true, 20, "baixa"
      );

      // Fam√≠lia
      addLote("familia",
        "Revis√£o de pens√£o aliment√≠cia",
        "Genitor requer redu√ß√£o do valor de alimentos por mudan√ßa de renda; outra parte alega renda informal maior.",
        false, 25, "m√©dia"
      );
      addLote("familia",
        "Guarda compartilhada com resid√™ncia fixa",
        "Pais desejam guarda compartilhada, mas divergem quanto √† resid√™ncia principal da crian√ßa.",
        false, 25, "baixa"
      );
      addLote("familia",
        "Regulamenta√ß√£o de visitas e f√©rias escolares",
        "Defini√ß√£o de finais de semana, feriados e f√©rias, com hist√≥rico de atrasos e conflitos entre os genitores.",
        false, 25, "m√©dia"
      );
      addLote("familia",
        "Ado√ß√£o e destitui√ß√£o do poder familiar",
        "Crian√ßa em acolhimento institucional; discute-se destitui√ß√£o do poder familiar e ado√ß√£o por novo n√∫cleo.",
        false, 25, "alta"
      );

      // Trabalhista
      addLote("trabalhista",
        "Horas extras habituais e intervalo intrajornada",
        "Empregado alega realiza√ß√£o de horas adicionais di√°rias sem pagamento correto e supress√£o de intervalo.",
        false, 30, "m√©dia"
      );
      addLote("trabalhista",
        "Reconhecimento de v√≠nculo em contrato PJ",
        "Trabalhador atuou como pessoa jur√≠dica por longo per√≠odo, alega subordina√ß√£o, pessoalidade e habitualidade.",
        false, 30, "alta"
      );
      addLote("trabalhista",
        "Ass√©dio moral e dano extrapatrimonial",
        "Relatos de humilha√ß√µes p√∫blicas, metas abusivas e mensagens ofensivas em grupos corporativos.",
        false, 40, "alta"
      );

      return casos;
    }

    // -------------------- IA SIMULADA GRATUITA --------------------
    async function iaFala(agente, caso, pergunta = "") {
      const resumo = caso.resumo;
      const provas = caso.provas.map(p => `[${p.id}] ${p.tipo}`).join(", ");

      let prefixo;
      if (agente === "acusacao") prefixo = "ACUSA√á√ÉO ‚Äî ";
      else if (agente === "defesa") prefixo = "DEFESA ‚Äî ";
      else prefixo = "TESTEMUNHA ‚Äî ";

      let foco;
      if (pergunta) {
        foco = `Respondendo √† pergunta do Juiz: "${pergunta}". `;
      } else {
        foco = "Exposi√ß√£o inicial dos pontos centrais. ";
      }

      let corpo;
      if (agente === "acusacao") {
        corpo = `A acusa√ß√£o destaca que o conjunto probat√≥rio (${provas}) aponta para a responsabilidade do r√©u. ` +
                `Pontua a coer√™ncia dos relatos e a compatibilidade dos laudos com a narrativa da v√≠tima. `;
      } else if (agente === "defesa") {
        corpo = `A defesa enfatiza lacunas, contradi√ß√µes e alternativas explicativas para os fatos descritos em ${provas}. ` +
                `Argumenta que persistem d√∫vidas razo√°veis e que a interpreta√ß√£o deve favorecer a liberdade ou a solu√ß√£o menos gravosa. `;
      } else {
        corpo = `A testemunha esclarece detalhes observados no dia dos fatos, sem emitir ju√≠zo jur√≠dico, ` +
                `relatando o que viu, ouviu e percebeu em rela√ß√£o ao cen√°rio descrito. `;
      }

      const final = `Em s√≠ntese, considerando o caso: ${resumo}`;

      const texto = prefixo + foco + corpo + final;
      await new Promise(r => setTimeout(r, 400));
      return texto;
    }

    // -------------------- COMPONENTES DE INTERFACE --------------------
    function SplashScreen({ onStart }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-black">
          <div className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl">
            <div
              className="absolute inset-0 bg-cover bg-center"
              style={{ backgroundImage: "url('img/capa.png')" }}
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent" />
            <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6">
              <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">
                Tribunal ‚Äì Simulador de Juiz
              </h1>
              <p className="text-sm opacity-90 mb-4 text-center">
                Vale Produ√ß√£o ‚Ä¢ Prot√≥tipo Educacional
              </p>
              <button
                onClick={onStart}
                className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
              >
                Iniciar
              </button>
            </div>
          </div>
        </div>
      );
    }

    function TutorialSalvamento({ onContinuar }) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
          <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
            <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
            <ol className="list-decimal pl-5 space-y-2 text-sm">
              <li>Seu progresso √© salvo automaticamente no pr√≥prio navegador (localStorage).</li>
              <li>Na tela de login, voc√™ pode exportar um arquivo <b>.json</b> com todos os perfis.</li>
              <li>Depois √© s√≥ importar esse arquivo em outro computador/celular para continuar de onde parou.</li>
            </ol>
            <p className="mt-4 text-xs opacity-80">
              Dica: use um nome de usu√°rio fixo (ex.: <b>DraMaria</b>, <b>AlunoJo√£o</b>) para acompanhar sua evolu√ß√£o.
            </p>
            <button
              onClick={onContinuar}
              className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entendi, ir para o login
            </button>
          </div>
        </div>
      );
    }

    function LoginScreen({ profiles, setProfiles, setCurrentProfile, onEnter }) {
      const [user, setUser] = useState("");
      const [file, setFile] = useState(null);

      function handleEnter() {
        const nome = user.trim();
        if (!nome) return;
        let novos = { ...profiles };
        if (!novos[nome]) {
          novos[nome] = {
            nome,
            court: null,
            estado: "SP",
            cidade: "S√£o Paulo",
            stats: { julgados: 0, acertos: 0, prestigio: 0 },
            stj: { ativo: false }
          };
        }
        setProfiles(novos);
        localStorage.setItem("juiz_profiles", JSON.stringify(novos));
        setCurrentProfile(nome);
        onEnter();
      }

      function handleExport() {
        const blob = new Blob([JSON.stringify(profiles, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "jogo-do-juiz-save.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function handleImport() {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            setProfiles(data);
            localStorage.setItem("juiz_profiles", JSON.stringify(data));
            alert("Save importado com sucesso!");
          } catch (err) {
            alert("Arquivo inv√°lido.");
          }
        };
        reader.readAsText(file);
      }

      return (
        <div
          className="min-h-screen bg-cover bg-center flex items-center justify-center"
          style={{ backgroundImage: "url('img/capa.png')" }}
        >
          <div className="bg-black/80 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
            <h1 className="text-xl font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
            <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
            <p className="text-xs text-center mb-4 opacity-80">
              Crie um usu√°rio para modo carreira ou use v√°rios perfis em modo estudo.
            </p>

            <div className="space-y-3">
              <div>
                <label className="text-xs opacity-80">Usu√°rio</label>
                <input
                  className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
                  value={user}
                  onChange={e => setUser(e.target.value)}
                  placeholder="Ex.: DraMaria, EstudanteJo√£o..."
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleEnter}
                  className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
                >
                  Entrar / Criar perfil
                </button>
                <button
                  onClick={handleExport}
                  className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
                >
                  Exportar save
                </button>
              </div>

              <div className="mt-2 text-xs">
                <div className="mb-1">Importar save:</div>
                <input
                  type="file"
                  accept=".json"
                  onChange={e => setFile(e.target.files[0] || null)}
                  className="text-xs"
                />
                <button
                  onClick={handleImport}
                  className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
                >
                  Importar
                </button>
              </div>
            </div>

            {Object.keys(profiles).length > 0 && (
              <div className="mt-4">
                <div className="text-xs mb-1 opacity-70">Perfis existentes:</div>
                <div className="flex flex-wrap gap-2">
                  {Object.keys(profiles).map(p => (
                    <button
                      key={p}
                      onClick={() => setUser(p)}
                      className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                    >
                      {p}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function CourtSelectScreen({ onSelect }) {
      const courts = [
        { id: "criminal", icon: "‚öñÔ∏è", nome: "Criminal", desc: "Crimes contra a pessoa e o patrim√¥nio." },
        { id: "familia", icon: "üë®‚Äçüë©‚Äçüëß", nome: "Fam√≠lia", desc: "Guarda, pens√£o, div√≥rcio, ado√ß√£o e medidas protetivas." },
        { id: "trabalhista", icon: "üíº", nome: "Trabalhista", desc: "V√≠nculo, verbas, jornada e ass√©dio moral." }
      ];
      return (
        <div className="min-h-screen bg-black flex items-center justify-center text-white">
          <div className="max-w-4xl w-full mx-4 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center">Escolha o Tribunal</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              {courts.map(c => (
                <button
                  key={c.id}
                  onClick={() => onSelect(c.id)}
                  className="p-5 rounded-3xl bg-white/10 border border-white/15 hover:bg-white/20 transition text-left"
                >
                  <div className="text-3xl mb-2">{c.icon}</div>
                  <div className="text-lg font-semibold">{c.nome}</div>
                  <p className="text-xs opacity-80 mt-1">{c.desc}</p>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function LocationSelect({ profile, onSelect }) {
      const [estado, setEstado] = useState(profile.estado || "SP");
      const [cidade, setCidade] = useState(profile.cidade || (ESTADOS[estado] || [])[0] || "");

      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center">
          <div className="bg-white/10 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
            <h2 className="text-2xl font-bold mb-4">Escolha a comarca</h2>
            <div className="mb-3">
              <label className="text-xs opacity-80">Estado</label>
              <select
                value={estado}
                onChange={e => {
                  const uf = e.target.value;
                  setEstado(uf);
                  const lista = ESTADOS[uf] || [];
                  setCidade(lista[0] || "");
                }}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {Object.keys(ESTADOS).map(uf => (
                  <option key={uf} value={uf}>{uf}</option>
                ))}
              </select>
            </div>
            <div className="mb-4">
              <label className="text-xs opacity-80">Cidade</label>
              <select
                value={cidade}
                onChange={e => setCidade(e.target.value)}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {(ESTADOS[estado] || []).map(c => (
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
            </div>
            <button
              onClick={() => onSelect(estado, cidade)}
              className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Confirmar
            </button>
          </div>
        </div>
      );
    }

    function ProvaViewer({ prova, onClose }) {
      if (!prova) return null;
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
          <div className="bg-slate-900 border border-white/15 rounded-3xl max-w-lg w-full mx-4 p-6">
            <h3 className="text-lg font-semibold mb-2">
              {prova.id} ‚Äî {prova.tipo}
            </h3>
            <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">
              {prova.conteudo}
            </p>
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
            >
              Fechar
            </button>
          </div>
        </div>
      );
    }

    function Escritorio({ profile, cases, onSelectCase, onSTJ, onRelatorio, sons }) {
      const fila = cases.filter(c => c.status === "na_fila" && c.tipo === profile.court);

      const julgados = profile.stats?.julgados || 0;
      const acertos = profile.stats?.acertos || 0;
      const prestigio = profile.stats?.prestigio || 0;
      const iaj = julgados ? Math.round((acertos / julgados) * 100) : 0;

      const stjElegivel = prestigio >= 60 && julgados >= 30 && !profile.stj?.ativo;

      return (
        <div
          className="min-h-screen relative bg-cover bg-center text-white"
          style={{ backgroundImage: "url('img/escritorio.png')" }}
        >
          <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
          <div className="relative z-10 max-w-6xl mx-auto p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
                <p className="text-xs opacity-80">
                  {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢{" "}
                  {profile.stj?.ativo ? "Ministro(a) STJ" : (profile.court || "sem tribunal")}
                </p>
              </div>
              <div className="text-xs text-right opacity-80">
                Casos julgados: {julgados}<br />
                Acertos (gabarito): {acertos}<br />
                IAJ: {iaj}%<br />
                Prest√≠gio: {prestigio}
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white/10 border border-white/10 rounded-3xl p-5">
                <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
                <div className="max-h-96 overflow-y-auto space-y-3 pr-2">
                  {fila.length === 0 && (
                    <p className="text-xs opacity-70">
                      Nenhum processo na fila para este tribunal.
                    </p>
                  )}
                  {fila.map(c => (
                    <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                      <h3 className="text-sm font-semibold mb-1">
                        {c.titulo}{" "}
                        <span className="text-[10px] opacity-70">
                          ‚Ä¢ dificuldade {c.dificuldade}
                        </span>
                      </h3>
                      <p className="text-xs opacity-80 mb-2">{c.resumo}</p>
                      <button
                        onClick={() => {
                          sons.gavel.play();
                          onSelectCase(c.id);
                        }}
                        className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                      >
                        Iniciar julgamento
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white/10 border border-white/10 rounded-3xl p-5 flex flex-col">
                <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
                <p className="text-xs opacity-80 mb-3">
                  Acompanhe sua evolu√ß√£o e utilize relat√≥rios para estudo em grupo e simulados.
                </p>
                <button
                  onClick={onRelatorio}
                  className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
                >
                  Ver relat√≥rio semestral
                </button>
                {stjElegivel && (
                  <button
                    onClick={onSTJ}
                    className="w-full px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-sm font-semibold mt-2"
                  >
                    Candidatar-se ao STJ
                  </button>
                )}
                {profile.stj?.ativo && (
                  <p className="mt-3 text-xs text-yellow-300">
                    Voc√™ j√° est√° atuando como Ministro(a) do STJ. Os casos agora simulam recursos especiais,
                    com foco em precedente e uniformiza√ß√£o de jurisprud√™ncia.
                  </p>
                )}
                <div className="mt-4 text-[10px] opacity-70">
                  Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function Julgamento({ caso, onVoltar, onDecidir, sons }) {
      const [falas, setFalas] = useState([]);
      const [pergunta, setPergunta] = useState("");
      const [provaSel, setProvaSel] = useState(null);
      const [jurados, setJurados] = useState(
        Array.from({ length: 12 }, (_, i) => ({ id: i + 1, voto: null, certeza: 0 }))
      );
      const [falando, setFalando] = useState("");
      const textoDigitado = useTypewriter(falando, 15);

      async function ouvir(agente) {
        const fala = await iaFala(agente, caso, "");
        setFalas(f => [...f, { autor: agente, texto: fala }]);
        setFalando(fala);
        sons.murmur.play();
      }

      async function perguntarIA() {
        if (!pergunta.trim()) return;
        const fala = await iaFala("testemunha", caso, pergunta);
        const blocoPerg = { autor: "juiz", texto: "Pergunta do Juiz: " + pergunta };
        const blocoResp = { autor: "testemunha", texto: fala };
        setFalas(f => [...f, blocoPerg, blocoResp]);
        setFalando(fala);
        setPergunta("");
        sons.murmur.play();
      }

      function deliberarJuri() {
        const novo = jurados.map(j => {
          const certeza = 50 + Math.round(Math.random() * 50);
          const votoCulpa = Math.random() < 0.55; // leve vi√©s condenat√≥rio
          return { ...j, voto: votoCulpa, certeza };
        });
        setJurados(novo);
        sons.murmur.play();
      }

      function decidir(veredito) {
        sons.gavel.play();
        onDecidir(veredito);
      }

      return (
        <div
          className="min-h-screen relative bg-cover bg-center text-white"
          style={{ backgroundImage: "url('img/tribunal.png')" }}
        >
          <div className="absolute inset-0 bg-black/75 backdrop-blur-sm"></div>
          <ProvaViewer prova={provaSel} onClose={() => setProvaSel(null)} />
          <div className="relative z-10 max-w-5xl mx-auto p-6">
            <button
              onClick={onVoltar}
              className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Voltar ao escrit√≥rio
            </button>
            <h1 className="text-2xl font-bold mb-1">Sala de Julgamento</h1>
            <p className="text-xs opacity-80 mb-4">{caso.titulo} ‚Äî {caso.resumo}</p>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 space-y-4">
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={() => ouvir("acusacao")}
                    className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                  >
                    ‚öñÔ∏è Palavra √† Acusa√ß√£o
                  </button>
                  <button
                    onClick={() => ouvir("defesa")}
                    className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    üõ°Ô∏è Ouvir Defesa
                  </button>
                  <button
                    onClick={() => ouvir("testemunha")}
                    className="px-3 py-1 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-xs font-semibold"
                  >
                    üë§ Ouvir Testemunha
                  </button>
                </div>

                <div className="bg-white/10 border border-white/10 rounded-3xl p-4 h-64 overflow-y-auto">
                  {falas.length === 0 && (
                    <p className="text-xs opacity-70">
                      Use os bot√µes acima para ouvir a acusa√ß√£o, defesa e testemunhas. As falas aparecer√£o aqui.
                    </p>
                  )}
                  {falas.map((f, idx) => (
                    <div key={idx} className="mb-3 text-xs">
                      <div className="font-semibold mb-1">
                        {f.autor === "acusacao" && "‚öñÔ∏è Acusa√ß√£o"}
                        {f.autor === "defesa" && "üõ°Ô∏è Defesa"}
                        {f.autor === "testemunha" && "üë§ Testemunha"}
                        {f.autor === "juiz" && "üë®‚Äç‚öñÔ∏è Juiz"}
                      </div>
                      <p className="opacity-90 whitespace-pre-wrap">{f.texto}</p>
                    </div>
                  ))}
                </div>

                <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                  <div className="text-xs mb-1 opacity-80">
                    Pergunta do juiz‚Ä¶ (atalho: Enter) ‚Äî IA responde como testemunha
                  </div>
                  <div className="flex gap-2">
                    <input
                      className="flex-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-xs"
                      value={pergunta}
                      onChange={e => setPergunta(e.target.value)}
                      onKeyDown={e => { if (e.key === "Enter") perguntarIA(); }}
                      placeholder="Ex.: H√° contradi√ß√µes entre os depoimentos? A arma foi periciada?..."
                    />
                    <button
                      onClick={perguntarIA}
                      className="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs font-semibold"
                    >
                      Perguntar
                    </button>
                  </div>
                  {textoDigitado && (
                    <div className="mt-3 text-xs border-t border-white/10 pt-2">
                      <div className="font-semibold mb-1">Resposta em tempo real:</div>
                      <p className="whitespace-pre-wrap opacity-90">{textoDigitado}</p>
                    </div>
                  )}
                </div>
              </div>

              <div className="space-y-4">
                <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                  <h3 className="text-sm font-semibold mb-2">Dossi√™ (Provas)</h3>
                  <ul className="space-y-2 max-h-40 overflow-y-auto text-xs">
                    {caso.provas.map(p => (
                      <li key={p.id}>
                        <button
                          onClick={() => setProvaSel(p)}
                          className="underline hover:text-emerald-300"
                        >
                          [{p.id}] {p.tipo}
                        </button>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                  <h3 className="text-sm font-semibold mb-2">J√∫ri Popular (12)</h3>
                  <div className="grid grid-cols-3 gap-2 text-[10px]">
                    {jurados.map(j => (
                      <div
                        key={j.id}
                        className="rounded-xl bg-white/5 px-2 py-2 flex flex-col items-center"
                      >
                        <div className="mb-1 font-semibold">
                          J{j.id.toString().padStart(2, "0")}
                        </div>
                        <div className="w-full h-1 bg-white/10 rounded-full overflow-hidden mb-1">
                          <div
                            className={
                              "h-1 rounded-full " +
                              (j.voto === null
                                ? "bg-white/30"
                                : j.voto
                                ? "bg-red-500"
                                : "bg-emerald-500")
                            }
                            style={{ width: `${j.certeza || 0}%` }}
                          />
                        </div>
                        <div className="opacity-80">
                          {j.voto === null ? "‚Äî" : j.voto ? "Culpa" : "Absolve"}
                        </div>
                      </div>
                    ))}
                  </div>
                  <button
                    onClick={deliberarJuri}
                    className="mt-3 w-full px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs font-semibold"
                  >
                    Iniciar Delibera√ß√£o
                  </button>
                </div>

                <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                  <h3 className="text-sm font-semibold mb-2">Veredito do Juiz</h3>
                  <div className="flex gap-2">
                    <button
                      onClick={() => decidir(true)}
                      className="flex-1 px-3 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                    >
                      Condenar
                    </button>
                    <button
                      onClick={() => decidir(false)}
                      className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                    >
                      Absolver
                    </button>
                  </div>
                  <p className="mt-2 text-[10px] opacity-70">
                    Em criminal, considere o padr√£o "al√©m de d√∫vida razo√°vel".
                    Em fam√≠lia e trabalho, pense em preponder√¢ncia da prova e melhores interesses.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // -------------------- APP PRINCIPAL --------------------
    function App() {
      const [screen, setScreen] = useState("splash"); // splash, tutorial, login, court, location, office, trial
      const [profiles, setProfiles] = useState({});
      const [currentName, setCurrentName] = useState(null);
      const [cases, setCases] = useState(() => seedCases());
      const [currentCaseId, setCurrentCaseId] = useState(null);

      const gavel = useSound(SOUND_URLS.gavel, true, 0.9);
      const murmur = useSound(SOUND_URLS.murmur, true, 0.5);
      const sons = { gavel, murmur };

      useEffect(() => {
        try {
          const raw = localStorage.getItem("juiz_profiles");
          if (raw) {
            const data = JSON.parse(raw);
            setProfiles(data);
          }
        } catch (e) {
          console.log("sem perfis salvos");
        }
      }, []);

      const currentProfile = currentName ? profiles[currentName] : null;

      function updateProfile(patch) {
        if (!currentProfile) return;
        const atualizado = { ...currentProfile, ...patch };
        const novos = { ...profiles, [currentProfile.nome]: atualizado };
        setProfiles(novos);
        localStorage.setItem("juiz_profiles", JSON.stringify(novos));
      }

      function handleSelectCourt(courtId) {
        updateProfile({ court: courtId });
        setScreen("location");
      }

      function handleLocation(estado, cidade) {
        updateProfile({ estado, cidade });
        setScreen("office");
      }

      function handleSelectCase(id) {
        setCurrentCaseId(id);
        setScreen("trial");
      }

      function handleDecidir(veredito) {
        // Atualiza caso
        setCases(prev =>
          prev.map(c =>
            c.id === currentCaseId
              ? { ...c, status: veredito ? "condenado" : "absolvido" }
              : c
          )
        );
        // Atualiza perfil
        const caso = cases.find(c => c.id === currentCaseId);
        if (caso && currentProfile) {
          const julgados = (currentProfile.stats?.julgados || 0) + 1;
          const acertos =
            (currentProfile.stats?.acertos || 0) +
            (veredito === caso.gabarito.culpado ? 1 : 0);
          const iaj = julgados ? acertos / julgados : 0;
          const prestigio = Math.min(
            100,
            Math.round(iaj * 70 + Math.min(30, julgados / 2))
          );
          updateProfile({
            stats: { julgados, acertos, prestigio }
          });
        }
        setScreen("office");
      }

      function handleSTJ() {
        updateProfile({ stj: { ativo: true } });
        alert("Parab√©ns! Voc√™ foi promovido(a) ao STJ nesta simula√ß√£o. Novos casos podem ser preparados futuramente.");
      }

      function handleRelatorio() {
        if (!currentProfile) return;
        const s = currentProfile.stats || { julgados: 0, acertos: 0, prestigio: 0 };
        const iaj = s.julgados ? Math.round((s.acertos / s.julgados) * 100) : 0;
        alert(
          `Relat√≥rio semestral (simulado):\n\n` +
          `Usu√°rio: ${currentProfile.nome}\n` +
          `Tribunal atual: ${currentProfile.stj?.ativo ? "STJ" : (currentProfile.court || "-")}\n` +
          `Comarca: ${currentProfile.cidade}/${currentProfile.estado}\n\n` +
          `Casos julgados: ${s.julgados}\n` +
          `Acertos (gabarito): ${s.acertos}\n` +
          `√çndice de Ader√™ncia Jur√≠dica (IAJ): ${iaj}%\n` +
          `Prest√≠gio aproximado: ${s.prestigio}\n\n` +
          `Use estes dados para discutir decis√µes, elaborar pareceres e simular sess√µes de estudo.`
        );
      }

      // Renderiza√ß√£o condicional
      if (screen === "splash") {
        return <SplashScreen onStart={() => setScreen("tutorial")} />;
      }

      if (screen === "tutorial") {
        return <TutorialSalvamento onContinuar={() => setScreen("login")} />;
      }

      if (screen === "login") {
        return (
          <LoginScreen
            profiles={profiles}
            setProfiles={setProfiles}
            setCurrentProfile={setCurrentName}
            onEnter={() => setScreen("court")}
          />
        );
      }

      if (!currentProfile) {
        return <div className="min-h-screen flex items-center justify-center">Carregando‚Ä¶</div>;
      }

      if (screen === "court") {
        return <CourtSelectScreen onSelect={handleSelectCourt} />;
      }

      if (screen === "location") {
        return <LocationSelect profile={currentProfile} onSelect={handleLocation} />;
      }

      if (screen === "office") {
        return (
          <Escritorio
            profile={currentProfile}
            cases={cases}
            onSelectCase={handleSelectCase}
            onSTJ={handleSTJ}
            onRelatorio={handleRelatorio}
            sons={sons}
          />
        );
      }

      if (screen === "trial" && currentCaseId) {
        const caso = cases.find(c => c.id === currentCaseId);
        if (!caso) {
          setScreen("office");
          return null;
        }
        return (
          <Julgamento
            caso={caso}
            onVoltar={() => setScreen("office")}
            onDecidir={handleDecidir}
            sons={sons}
          />
        );
      }

      return <div className="min-h-screen flex items-center justify-center">Carregando‚Ä¶</div>;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
