<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Jogo do Juiz ‚Äî Vale Produ√ß√£o</title>

  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root {
      height: 100%;
    }
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---------------- HOOK: M√ÅQUINA DE ESCREVER ----------------
    function useTypewriter(fullText, speed = 20) {
      const [text, setText] = useState("");
      useEffect(() => {
        if (!fullText) {
          setText("");
          return;
        }
        setText("");
        let i = 0;
        const id = setInterval(() => {
          i++;
          setText(fullText.slice(0, i));
          if (i >= fullText.length) clearInterval(id);
        }, speed);
        return () => clearInterval(id);
      }, [fullText, speed]);
      return text;
    }

    // ---------------- SOM ----------------
    const SOUND_URLS = {
      gavel:"https://cdn.pixabay.com/download/audio/2022/03/15/audio_b8e7f6b3a0.mp3?filename=judge-gavel-182004.mp3",
      murmur:"https://cdn.pixabay.com/download/audio/2021/09/16/audio_7b4b2d7f6c.mp3?filename=crowd-murmur-ambient-75537.mp3"
    };

    function useSound(url, enabled = true, volume = 0.7) {
      const ref = useRef(null);
      useEffect(() => {
        const a = new Audio(url);
        a.volume = volume;
        ref.current = a;
        return () => {
          a.pause();
          ref.current = null;
        };
      }, [url]);
      const play = () => {
        if (enabled && ref.current) {
          ref.current.currentTime = 0;
          ref.current.play();
        }
      };
      return { play };
    }

    // ---------------- ESTADOS ----------------
    const ESTADOS = {
      "AC":["Rio Branco"],"AL":["Macei√≥"],"AP":["Macap√°"],"AM":["Manaus"],
      "BA":["Salvador","Feira de Santana","Vit√≥ria da Conquista"],
      "CE":["Fortaleza"],"DF":["Bras√≠lia"],"ES":["Vit√≥ria"],"GO":["Goi√¢nia"],
      "MA":["S√£o Lu√≠s"],"MT":["Cuiab√°"],"MS":["Campo Grande"],
      "MG":["Belo Horizonte","Uberl√¢ndia","Juiz de Fora"],
      "PA":["Bel√©m"],"PB":["Jo√£o Pessoa"],"PR":["Curitiba","Londrina"],
      "PE":["Recife"],"PI":["Teresina"],"RJ":["Rio de Janeiro","Niter√≥i"],
      "RN":["Natal"],"RS":["Porto Alegre","Caxias do Sul"],
      "RO":["Porto Velho"],"RR":["Boa Vista"],
      "SC":["Florian√≥polis","Joinville"],
      "SP":["S√£o Paulo","Campinas","Santos","Sorocaba"],
      "SE":["Aracaju"],"TO":["Palmas"]
    };

    // ---------------- CASOS ----------------
    function seedCases(){
      const casos = [];
      let id = 1;

      function addLote(tipo, titulo, resumo, gabarito, dificuldade){
        for(let i=0;i<8;i++){
          casos.push({
            id: tipo + "-" + id++,
            tipo,
            titulo: titulo + " (" + dificuldade + ") #" + (i+1),
            resumo,
            gabarito,
            dificuldade,
            provas: [
              {
                id:"E1",
                tipo:"boletim",
                conteudo:"Boletim/registro oficial do fato, com hor√°rio, local, identifica√ß√£o das partes e breve narrativa."
              },
              {
                id:"E2",
                tipo:"laudo",
                conteudo:"Laudo t√©cnico descrevendo circunst√¢ncias, danos e/ou les√µes, com metodologia e conclus√£o."
              },
              {
                id:"E3",
                tipo:"testemunha",
                conteudo:"Depoimento de testemunha, indicando pontos de converg√™ncia e diverg√™ncia entre as vers√µes."
              }
            ],
            status:"na_fila"
          });
        }
      }

      // Criminal
      addLote(
        "criminal",
        "Furto simples em com√©rcio",
        "Subtra√ß√£o de bem em com√©rcio, sem viol√™ncia ou grave amea√ßa, com imagens de c√¢meras de seguran√ßa.",
        {culpado:true},
        "f√°cil"
      );
      addLote(
        "criminal",
        "Roubo em via p√∫blica",
        "Apropria√ß√£o de bens com grave amea√ßa ou viol√™ncia, v√≠tima reconhece o autor em sede policial.",
        {culpado:true},
        "m√©dio"
      );
      addLote(
        "criminal",
        "Les√£o corporal em contexto dom√©stico",
        "Discuss√£o em ambiente familiar, alega√ß√£o de agress√µes f√≠sicas, vers√µes conflitantes e medida protetiva pr√©via.",
        {culpado:true},
        "m√©dio"
      );
      addLote(
        "criminal",
        "Homic√≠dio em briga de bar",
        "Discuss√£o em bar que evolui para agress√£o grave com resultado morte, com alega√ß√£o de leg√≠tima defesa.",
        {culpado:true},
        "dif√≠cil"
      );

      // Fam√≠lia
      addLote(
        "familia",
        "Revis√£o de alimentos",
        "Pedido de redu√ß√£o ou majora√ß√£o de pens√£o aliment√≠cia diante de altera√ß√£o da capacidade financeira.",
        {culpado:false},
        "m√©dio"
      );
      addLote(
        "familia",
        "Guarda compartilhada",
        "Defini√ß√£o de resid√™ncia principal de menor e regime de conviv√™ncia; ambos os genitores considerados aptos.",
        {culpado:false},
        "m√©dio"
      );
      addLote(
        "familia",
        "Aliena√ß√£o parental",
        "Alega√ß√µes de interfer√™ncia na forma√ß√£o psicol√≥gica da crian√ßa, com mensagens e relatos de profissionais.",
        {culpado:true},
        "dif√≠cil"
      );
      addLote(
        "familia",
        "Medida protetiva",
        "Pedido de prote√ß√£o com base em viol√™ncia psicol√≥gica e amea√ßas constantes, com boletins de ocorr√™ncia.",
        {culpado:true},
        "dif√≠cil"
      );

      // Trabalhista
      addLote(
        "trabalhista",
        "Horas extras habituais",
        "Discuss√£o sobre jornada ampliada, cart√µes de ponto com inconsist√™ncias e testemunhas que confirmam extrapola√ß√£o.",
        {culpado:false},
        "m√©dio"
      );
      addLote(
        "trabalhista",
        "V√≠nculo de emprego x PJ",
        "Trabalho formalizado como PJ, mas com subordina√ß√£o, pessoalidade e exclusividade no dia a dia.",
        {culpado:true},
        "dif√≠cil"
      );
      addLote(
        "trabalhista",
        "Adicional de insalubridade",
        "Empregado exposto a agentes nocivos, per√≠cia indica grau de exposi√ß√£o e uso parcial de EPIs.",
        {culpado:true},
        "m√©dio"
      );
      addLote(
        "trabalhista",
        "Ass√©dio moral no trabalho",
        "Relatos de humilha√ß√µes p√∫blicas, cobran√ßas excessivas e ofensas em mensagens corporativas.",
        {culpado:true},
        "dif√≠cil"
      );

      return casos;
    }

    // ---------------- IA SIMULADA ----------------
    async function iaFala(agente, caso, pergunta=""){
      const resumo = caso.resumo;
      const provasTexto = caso.provas
        .map(p => "[" + p.id + "] " + p.tipo + ": " + p.conteudo)
        .join(" ");

      let prefixo;
      if(agente === "acusacao") prefixo = "ACUSA√á√ÉO: ";
      else if(agente === "defesa") prefixo = "DEFESA: ";
      else if(agente === "juiz") prefixo = "JUIZ: ";
      else prefixo = "RESPOSTA: ";

      const foco = pergunta
        ? 'Respondendo √† pergunta do Juiz: "' + pergunta + '". '
        : "Organizando os principais elementos constantes dos autos. ";

      let abordagem = "";
      if(agente === "acusacao"){
        abordagem =
          "A acusa√ß√£o enfatiza os elementos que apontam para a responsabilidade do acusado, " +
          "buscando demonstrar a sufici√™ncia da prova produzida diante do padr√£o probat√≥rio aplic√°vel. ";
      }else if(agente === "defesa"){
        abordagem =
          "A defesa destaca contradi√ß√µes, lacunas e hip√≥teses alternativas, invocando o princ√≠pio da d√∫vida razo√°vel " +
          "e a necessidade de preserva√ß√£o dos direitos fundamentais. ";
      }else{
        abordagem =
          "A resposta busca esclarecer os fatos relevantes a partir das provas constantes do processo, " +
          "sem substituir a convic√ß√£o do Juiz, mas oferecendo um resumo coerente. ";
      }

      const usoProvas =
        "Provas relevantes: " + provasTexto +
        " A an√°lise conjunta desses elementos permite avaliar a coer√™ncia das vers√µes, a robustez da prova documental " +
        "e o peso dos depoimentos prestados em ju√≠zo.";

      const texto = prefixo + foco + abordagem + "Resumo do caso: " + resumo + " " + usoProvas;

      await new Promise(r => setTimeout(r, 300));
      return texto;
    }

    // ---------------- COMPONENTES VISUAIS ----------------
    function SplashScreen({onStart}){
      return (
        <div className="min-h-screen flex items-center justify-center bg-black">
          <div className="relative w-full max-w-md h-[520px] rounded-3xl overflow-hidden shadow-2xl">
            <div className="absolute inset-0 bg-[url('capa.jpg')] bg-cover bg-center" />
            <div className="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent" />
            <div className="relative z-10 h-full flex flex-col items-center justify-end pb-10 px-6">
              <h1 className="text-3xl font-bold mb-1 drop-shadow-lg text-center">Jogo do Juiz</h1>
              <p className="text-sm opacity-90 mb-4 text-center">Vale Produ√ß√£o ‚Ä¢ Simulador Educacional</p>
              <button
                onClick={onStart}
                className="px-6 py-3 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold shadow-xl"
              >
                Iniciar
              </button>
            </div>
          </div>
        </div>
      );
    }

    function TutorialSalvamento({onContinuar}){
      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-slate-950 via-slate-900 to-black text-white">
          <div className="max-w-xl w-full mx-4 p-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur">
            <h2 className="text-2xl font-bold mb-3">Como o jogo salva seu progresso</h2>
            <ol className="list-decimal pl-5 space-y-2 text-sm">
              <li>O jogo grava automaticamente sua carreira no pr√≥prio navegador (localStorage).</li>
              <li>Voc√™ pode exportar um arquivo de backup (.json) pela tela de login.</li>
              <li>Depois, pode importar esse arquivo em outro dispositivo e continuar de onde parou.</li>
            </ol>
            <p className="mt-4 text-xs opacity-80">
              Dica: use um nome de usu√°rio fixo (ex.: <b>DraMaria</b>) para manter sua carreira organizada.
            </p>
            <button
              onClick={onContinuar}
              className="mt-5 px-5 py-2 rounded-2xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Entendi, ir para o login
            </button>
          </div>
        </div>
      );
    }

    function LoginScreen({profiles,setProfiles,setCurrentProfile,onEnter}){
      const [user,setUser] = useState("");
      const [file,setFile] = useState(null);

      function handleEnter(){
        if(!user.trim()) return;
        if(!profiles[user]){
          const novo = {
            nome:user.trim(),
            court:null,
            estado:"SP",
            cidade:"S√£o Paulo",
            stats:{julgados:0,acertos:0,prestigio:0}
          };
          const updated = Object.assign({}, profiles, {[user]:novo});
          setProfiles(updated);
          try{
            localStorage.setItem("juiz_profiles", JSON.stringify(updated));
          }catch(e){}
        }
        setCurrentProfile(user.trim());
        onEnter();
      }

      function handleExport(){
        const blob = new Blob([JSON.stringify(profiles,null,2)],{type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "jogo-do-juiz-save.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function handleImport(){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e=>{
          try{
            const data = JSON.parse(e.target.result);
            setProfiles(data);
            try{
              localStorage.setItem("juiz_profiles", JSON.stringify(data));
            }catch(err){}
            alert("Save importado com sucesso!");
          }catch(err){
            alert("Arquivo inv√°lido.");
          }
        };
        reader.readAsText(file);
      }

      return (
        <div className="min-h-screen bg-[url('capa.jpg')] bg-cover bg-center flex items-center justify-center">
          <div className="bg-black/75 text-white max-w-lg w-full mx-4 p-6 rounded-3xl border border-white/10 backdrop-blur">
            <h1 className="text-xl font-semibold mb-1 text-center">Vale Produ√ß√£o apresenta</h1>
            <h2 className="text-3xl font-bold text-center mb-4">Jogo do Juiz</h2>
            <p className="text-xs text-center mb-4 opacity-80">
              Crie seu usu√°rio ou escolha um j√° existente. Exporte/importe seu progresso quando quiser.
            </p>

            <div className="space-y-3">
              <div>
                <label className="text-xs opacity-80">Usu√°rio</label>
                <input
                  className="w-full mt-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
                  value={user}
                  onChange={e=>setUser(e.target.value)}
                  placeholder="Ex.: DraMaria, EstudanteJo√£o..."
                />
              </div>

              <div className="flex gap-2">
                <button
                  onClick={handleEnter}
                  className="flex-1 px-3 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
                >
                  Entrar / Criar perfil
                </button>
                <button
                  onClick={handleExport}
                  className="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
                >
                  Exportar save
                </button>
              </div>

              <div className="mt-2 text-xs">
                <div className="mb-1">Importar save:</div>
                <input
                  type="file"
                  accept=".json"
                  onChange={e=>setFile(e.target.files[0]||null)}
                  className="text-xs"
                />
                <button
                  onClick={handleImport}
                  className="ml-2 px-3 py-1 rounded-xl bg-sky-500 hover:bg-sky-600 text-xs"
                >
                  Importar
                </button>
              </div>
            </div>

            {Object.keys(profiles).length>0 && (
              <div className="mt-4">
                <div className="text-xs mb-1 opacity-70">Perfis:</div>
                <div className="flex flex-wrap gap-2">
                  {Object.keys(profiles).map(p=>(
                    <button
                      key={p}
                      onClick={()=>setUser(p)}
                      className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-xs"
                    >
                      {p}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function CourtSelectScreen({onSelectCourt}){
      const courts = [
        {id:"criminal",icon:"‚öñÔ∏è",nome:"Criminal",desc:"Crimes contra a pessoa e o patrim√¥nio."},
        {id:"familia",icon:"üë®‚Äçüë©‚Äçüëß",nome:"Fam√≠lia",desc:"Guarda, pens√£o, div√≥rcio e medidas protetivas."},
        {id:"trabalhista",icon:"üíº",nome:"Trabalhista",desc:"V√≠nculo, verbas, jornada e danos morais."}
      ];
      return (
        <div className="min-h-screen bg-black flex items-center justify-center text-white">
          <div className="max-w-4xl w-full mx-4 p-6">
            <h2 className="text-3xl font-bold mb-6 text-center">Escolha o Tribunal</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
              {courts.map(c=>(
                <button
                  key={c.id}
                  onClick={()=>onSelectCourt(c.id)}
                  className="p-5 rounded-3xl bg-white/10 border border-white/15 hover:bg-white/20 transition text-left"
                >
                  <div className="text-3xl mb-2">{c.icon}</div>
                  <div className="text-lg font-semibold">{c.nome}</div>
                  <p className="text-xs opacity-80 mt-1">{c.desc}</p>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function LocationSelect({profile,onSelectLocation}){
      const [estado,setEstado] = useState(profile.estado||"SP");
      const cidades = ESTADOS[estado] || [];
      const [cidade,setCidade] = useState(profile.cidade||cidades[0]||"");

      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center">
          <div className="bg-white/10 p-6 rounded-3xl max-w-md w-full mx-4 border border-white/10">
            <h2 className="text-2xl font-bold mb-4">Escolha a comarca</h2>
            <div className="mb-3">
              <label className="text-xs opacity-80">Estado</label>
              <select
                value={estado}
                onChange={e=>{
                  const uf = e.target.value;
                  setEstado(uf);
                  const lista = ESTADOS[uf]||[];
                  setCidade(lista[0]||"");
                }}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {Object.keys(ESTADOS).map(uf=>(
                  <option key={uf} value={uf}>{uf}</option>
                ))}
              </select>
            </div>
            <div className="mb-4">
              <label className="text-xs opacity-80">Cidade</label>
              <select
                value={cidade}
                onChange={e=>setCidade(e.target.value)}
                className="w-full mt-1 px-3 py-2 bg-white/10 rounded-xl outline-none text-sm"
              >
                {(ESTADOS[estado]||[]).map(c=>(
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
            </div>
            <button
              onClick={()=>onSelectLocation(estado,cidade)}
              className="w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Confirmar
            </button>
          </div>
        </div>
      );
    }

    function ProvaViewer({prova,onClose}){
      if(!prova) return null;
      return (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-40">
          <div className="bg-slate-900 border border-white/15 rounded-3xl max-w-lg w-full mx-4 p-6">
            <h3 className="text-lg font-semibold mb-2">{prova.id} ‚Äî {prova.tipo}</h3>
            <p className="text-sm whitespace-pre-wrap opacity-90 mb-4">{prova.conteudo}</p>
            <button
              onClick={onClose}
              className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
            >
              Fechar
            </button>
          </div>
        </div>
      );
    }

    function Escritorio({profile,cases,onSelectCase,onRelatorio,sons}){
      const fila = cases.filter(c=>c.status === "na_fila");
      return (
        <div className="min-h-screen relative bg-[url('escritorio.jpg')] bg-cover bg-center text-white">
          <div className="absolute inset-0 bg-black/65 backdrop-blur-sm"></div>
          <div className="relative z-10 max-w-6xl mx-auto p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-2xl font-bold">Escrit√≥rio do Juiz</h1>
                <p className="text-xs opacity-80">
                  {profile.nome} ‚Äî {profile.cidade}/{profile.estado} ‚Ä¢ {profile.court || "sem tribunal"}
                </p>
              </div>
              <div className="text-xs text-right opacity-80">
                Julgados: {profile.stats?.julgados || 0}<br/>
                Acertos: {profile.stats?.acertos || 0}<br/>
                Prest√≠gio: {profile.stats?.prestigio || 0}
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white/10 border border-white/10 rounded-3xl p-5">
                <h2 className="text-lg font-semibold mb-3">Fila de processos</h2>
                <div className="max-h-96 overflow-y-auto space-y-3 pr-2">
                  {fila.length === 0 && (
                    <p className="text-xs opacity-70">Nenhum processo na fila para este tribunal.</p>
                  )}
                  {fila.map(c=>(
                    <div key={c.id} className="p-3 rounded-2xl bg-white/5 border border-white/10">
                      <h3 className="text-sm font-semibold mb-1">{c.titulo}</h3>
                      <p className="text-xs opacity-80 mb-2">{c.resumo}</p>
                      <button
                        onClick={()=>{
                          sons.gavel.play();
                          onSelectCase(c.id);
                        }}
                        className="px-3 py-1 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                      >
                        Iniciar julgamento
                      </button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white/10 border border-white/10 rounded-3xl p-5 flex flex-col">
                <h2 className="text-lg font-semibold mb-3">Painel da carreira</h2>
                <p className="text-xs opacity-80 mb-3">
                  Acompanhe sua evolu√ß√£o e acesse relat√≥rios para estudo e aprimoramento.
                </p>
                <button
                  onClick={onRelatorio}
                  className="mb-2 w-full px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-sm font-semibold"
                >
                  Ver relat√≥rio semestral
                </button>
                <div className="mt-4 text-[10px] opacity-70">
                  Simula√ß√£o educacional inspirada em rotinas reais, sem valor jur√≠dico.
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function Julgamento({caso,setCaso,onVoltar,sons}){
      const [falas,setFalas] = useState([]);
      const [pergunta,setPergunta] = useState("");
      const [provaSel,setProvaSel] = useState(null);
      const [jurados,setJurados] = useState(
        Array.from({length:12},(_,i)=>({id:i+1,voto:null,certeza:0}))
      );

      function getAvatar(autor){
        if(autor === "acusacao") return "‚öñÔ∏èüî¥";
        if(autor === "defesa") return "üëîüîµ";
        if(autor === "juiz") return "üë®‚Äç‚öñÔ∏è";
        return "üó£Ô∏è";
      }

      const ultimoTexto = falas.length > 0 ? falas[falas.length - 1].texto : "";
      const typedUltimo = useTypewriter(ultimoTexto, 18);

      async function ouvir(ag){
        const fala = await iaFala(ag,caso,"");
        setFalas(f=>[...f,{autor:ag,texto:fala}]);
        sons.murmur.play();
      }

      async function perguntarIA(){
        if(!pergunta.trim()) return;
        const fala = await iaFala("resposta",caso,pergunta);
        setFalas(f=>[
          ...f,
          {autor:"juiz",texto:"Pergunta do Juiz: " + pergunta},
          {autor:"resposta",texto:fala}
        ]);
        setPergunta("");
        sons.murmur.play();
      }

      function deliberarJuri(){
        const novo = jurados.map(j=>{
          const probCulpa = caso.gabarito.culpado ? 0.7 : 0.4;
          const voto = Math.random() < probCulpa;
          const certeza = Math.round(50 + Math.random()*50);
          return {id:j.id,voto,certeza};
        });
        setJurados(novo);
        sons.murmur.play();
      }

      function decidir(veredito){
        const correto = veredito === caso.gabarito.culpado;
        const novoStatus = veredito ? "condenado" : "absolvido";
        const atualizado = Object.assign({}, caso, {status:novoStatus});
        setCaso(atualizado);
        alert(
          (correto
            ? "Decis√£o alinhada ao gabarito pedag√≥gico. "
            : "Na simula√ß√£o, o gabarito apontava solu√ß√£o diversa. "
          ) + "Use o resultado para refletir sobre sua fundamenta√ß√£o."
        );
        onVoltar();
      }

      return (
        <div className="min-h-screen relative bg-[url('saladejulgamento.jpg')] bg-cover bg-center text-white">
          <div className="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
          <ProvaViewer prova={provaSel} onClose={()=>setProvaSel(null)} />
          <div className="relative z-10 max-w-6xl mx-auto p-6">
            <button
              onClick={onVoltar}
              className="mb-4 px-3 py-1 rounded-xl bg-white/10 hover:bg-white/20 text-xs"
            >
              Voltar ao escrit√≥rio
            </button>
            <h1 className="text-2xl font-bold mb-1">{caso.titulo}</h1>
            <p className="text-xs opacity-80 mb-4">{caso.resumo}</p>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2">
                <div className="mb-3 flex flex-wrap gap-2">
                  <button
                    onClick={()=>ouvir("acusacao")}
                    className="px-3 py-1 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold"
                  >
                    Ouvir Acusa√ß√£o
                  </button>
                  <button
                    onClick={()=>ouvir("defesa")}
                    className="px-3 py-1 rounded-xl bg-blue-500 hover:bg-blue-600 text-xs font-semibold"
                  >
                    Ouvir Defesa
                  </button>
                  <button
                    onClick={deliberarJuri}
                    className="px-3 py-1 rounded-xl bg-amber-500 hover:bg-amber-600 text-xs font-semibold"
                  >
                    Delibera√ß√£o do J√∫ri
                  </button>
                </div>

                <div className="max-h-64 overflow-y-auto space-y-2 pr-2">
                  {falas.map((f,i)=>{
                    const isLast = i === falas.length - 1;
                    const texto = isLast ? typedUltimo : f.texto;
                    return (
                      <div key={i} className="p-3 rounded-2xl bg-white/10 border border-white/15 flex gap-2">
                        <div className="text-lg">{getAvatar(f.autor)}</div>
                        <div>
                          <p className="text-[11px] opacity-70 mb-1">
                            {f.autor==="acusacao"?"ACUSA√á√ÉO":
                             f.autor==="defesa"?"DEFESA":
                             f.autor==="juiz"?"JUIZ":"RESPOSTA"}
                          </p>
                          <p className="text-sm whitespace-pre-wrap">{texto}</p>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div className="mt-4 flex gap-2">
                  <input
                    value={pergunta}
                    onChange={e=>setPergunta(e.target.value)}
                    placeholder="Pergunta do Juiz..."
                    className="flex-1 px-3 py-2 rounded-xl bg-white/10 outline-none text-sm"
                  />
                  <button
                    onClick={perguntarIA}
                    className="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-xs font-semibold"
                  >
                    Perguntar
                  </button>
                </div>

                <div className="mt-4 flex gap-2">
                  <button
                    onClick={()=>decidir(true)}
                    className="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold"
                  >
                    Condenar
                  </button>
                  <button
                    onClick={()=>decidir(false)}
                    className="px-4 py-2 rounded-xl bg-blue-500 hover:bg-blue-600 text-sm font-semibold"
                  >
                    Absolver
                  </button>
                </div>
              </div>

              <div className="space-y-4">
                <div className="bg-white/10 border border-white/10 rounded-3xl p-4 max-h-60 overflow-y-auto">
                  <h3 className="text-sm font-semibold mb-2">Provas</h3>
                  {caso.provas.map(p=>(
                    <button
                      key={p.id}
                      onClick={()=>setProvaSel(p)}
                      className="w-full text-left mb-2 px-3 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-xs"
                    >
                      {p.id} ‚Äî {p.tipo}
                    </button>
                  ))}
                </div>

                <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                  <h3 className="text-sm font-semibold mb-2">J√∫ri Popular</h3>
                  <div className="grid grid-cols-4 gap-2">
                    {jurados.map(j=>(
                      <div key={j.id} className="rounded-xl bg-white/10 p-1 text-center text-[10px]">
                        <div className="opacity-70">J{j.id.toString().padStart(2,"0")}</div>
                        <div className="h-1 w-full bg-white/10 rounded-full mt-1">
                          <div
                            className={
                              "h-1 rounded-full " +
                              (j.voto === null
                                ? "bg-white/30"
                                : j.voto
                                  ? "bg-red-500"
                                  : "bg-emerald-500")
                            }
                            style={{width:(j.certeza || 0) + "%"}}
                          ></div>
                        </div>
                        <div className="mt-1">
                          {j.voto === null ? "‚Äì" : (j.voto ? "C" : "A")}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>

            <p className="mt-4 text-[10px] opacity-70">
              Padr√£o probat√≥rio e enredo simplificados para fins pedag√≥gicos. J√∫ri popular aqui √© visual e educativo.
            </p>
          </div>
        </div>
      );
    }

    function RelatorioScreen({profile,onVoltar,cases}){
      const julgados = cases.filter(c=>c.status !== "na_fila");
      const acertos = profile.stats?.acertos || 0;
      const prestigio = profile.stats?.prestigio || 0;
      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center p-6">
          <div className="bg-white/10 border border-white/10 rounded-3xl max-w-xl w-full mx-4 p-6">
            <h1 className="text-2xl font-bold mb-3">Relat√≥rio semestral</h1>
            <p className="text-xs opacity-80 mb-4">
              Juiz: {profile.nome}<br/>
              Comarca: {profile.cidade}/{profile.estado}<br/>
              Tribunal: {profile.court || "n√£o definido"}
            </p>
            <div className="space-y-2 text-sm">
              <p>Casos julgados: {julgados.length}</p>
              <p>Acertos (gabarito da simula√ß√£o): {acertos}</p>
              <p>Prest√≠gio acumulado: {prestigio}</p>
            </div>
            <button
              onClick={onVoltar}
              className="mt-5 w-full px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold"
            >
              Voltar ao escrit√≥rio
            </button>
          </div>
        </div>
      );
    }

    // ---------------- APP PRINCIPAL ----------------
    function App(){
      const [screen,setScreen] = useState("splash");
      const [profiles,setProfiles] = useState(()=>{
        try{
          const raw = localStorage.getItem("juiz_profiles");
          return raw ? JSON.parse(raw) : {};
        }catch(e){
          return {};
        }
      });
      const [currentProfileId,setCurrentProfileId] = useState(null);
      const [cases,setCases] = useState(()=>seedCases());
      const [currentCase,setCurrentCase] = useState(null);

      const sons = {
        gavel: useSound(SOUND_URLS.gavel,true,0.8),
        murmur: useSound(SOUND_URLS.murmur,true,0.4)
      };

      useEffect(()=>{
        try{
          localStorage.setItem("juiz_profiles", JSON.stringify(profiles));
        }catch(e){}
      },[profiles]);

      const currentProfile = currentProfileId ? profiles[currentProfileId] : null;

      function handleSelectCourt(courtId){
        if(!currentProfile) return;
        const updated = Object.assign({}, currentProfile, {court:courtId});
        const newProfiles = Object.assign({}, profiles, {[currentProfileId]:updated});
        setProfiles(newProfiles);
        setScreen("location");
      }

      function handleSelectLocation(estado,cidade){
        if(!currentProfile) return;
        const updated = Object.assign({}, currentProfile, {estado,cidade});
        const newProfiles = Object.assign({}, profiles, {[currentProfileId]:updated});
        setProfiles(newProfiles);
        setScreen("office");
      }

      function handleSelectCase(caseId){
        const c = cases.find(x=>x.id === caseId);
        if(!c) return;
        setCurrentCase(c);
        setScreen("trial");
      }

      function handleUpdateCase(updatedCase){
        setCases(prev => prev.map(c => c.id === updatedCase.id ? updatedCase : c));
        setCurrentCase(updatedCase);
        if(currentProfileId){
          const prof = profiles[currentProfileId];
          const julgados = (prof.stats?.julgados || 0) + 1;
          const acertou = updatedCase.status === (updatedCase.gabarito.culpado ? "condenado" : "absolvido");
          const acertos = (prof.stats?.acertos || 0) + (acertou ? 1 : 0);
          const prestigio = Math.min(100, Math.round((acertos / (julgados || 1)) * 80));
          const stats = {julgados,acertos,prestigio};
          const updatedProfile = Object.assign({}, prof, {stats});
          const newProfiles = Object.assign({}, profiles, {[currentProfileId]:updatedProfile});
          setProfiles(newProfiles);
        }
      }

      function handleBackToOffice(){
        setScreen("office");
      }

      function handleRelatorio(){
        setScreen("relatorio");
      }

      if(screen === "splash"){
        return <SplashScreen onStart={()=>setScreen("tutorial")} />;
      }
      if(screen === "tutorial"){
        return <TutorialSalvamento onContinuar={()=>setScreen("login")} />;
      }
      if(screen === "login"){
        return (
          <LoginScreen
            profiles={profiles}
            setProfiles={setProfiles}
            setCurrentProfile={setCurrentProfileId}
            onEnter={()=>setScreen("court")}
          />
        );
      }
      if(!currentProfile){
        return (
          <div className="min-h-screen bg-black text-white flex items-center justify-center">
            <button
              onClick={()=>setScreen("login")}
              className="px-4 py-2 rounded-xl bg-emerald-500"
            >
              Voltar ao login
            </button>
          </div>
        );
      }
      if(screen === "court"){
        return <CourtSelectScreen onSelectCourt={handleSelectCourt} />;
      }
      if(screen === "location"){
        return (
          <LocationSelect
            profile={currentProfile}
            onSelectLocation={handleSelectLocation}
          />
        );
      }
      if(screen === "office"){
        const filteredCases = cases.filter(c=>c.tipo === (currentProfile.court || "criminal"));
        return (
          <Escritorio
            profile={currentProfile}
            cases={filteredCases}
            onSelectCase={handleSelectCase}
            onRelatorio={handleRelatorio}
            sons={sons}
          />
        );
      }
      if(screen === "trial" && currentCase){
        return (
          <Julgamento
            caso={currentCase}
            setCaso={handleUpdateCase}
            onVoltar={handleBackToOffice}
            sons={sons}
          />
        );
      }
      if(screen === "relatorio"){
        const filteredCases = cases.filter(c=>c.tipo === (currentProfile.court || "criminal"));
        return (
          <RelatorioScreen
            profile={currentProfile}
            cases={filteredCases}
            onVoltar={handleBackToOffice}
          />
        );
      }

      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center">
          <button
            onClick={()=>setScreen("splash")}
            className="px-4 py-2 rounded-xl bg-emerald-500"
          >
            Reiniciar
          </button>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
