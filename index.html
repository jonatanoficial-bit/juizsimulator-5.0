<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Tribunal ‚Äì Simulador de Juiz 4.2</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg-dark:#020617;
    --glass:#020617dd;
    --accent:#22c55e;
    --accent-soft:#4ade80;
    --danger:#f97373;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --card:#020617ee;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{
    background:var(--bg-dark);
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    min-height:100vh;
  }
  button,input,select,textarea{font-family:inherit;}
  .screen{min-height:100vh;display:none;}
  .screen.active{display:block;}

  .bg-splash{
    background-image:url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/capa.png");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .bg-office{
    background-image:url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/escritorio.png");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .bg-court{
    background-image:url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/tribunal.png");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .bg-stj{
    background-image:url("https://jonatanoficial-bit.github.io/juizsimulator-4.0/img/stj.png");
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }
  .overlay{
    background:radial-gradient(circle at 10% 0%,rgba(15,23,42,.9) 0,rgba(15,23,42,.8) 35%,rgba(15,23,42,.95) 100%);
    min-height:100vh;
    padding:1.5rem;
  }
  .container{max-width:1100px;margin:0 auto;}
  .glass{
    background:var(--glass);
    border-radius:1.25rem;
    padding:1.5rem;
    box-shadow:0 25px 40px rgba(0,0,0,.65);
    border:1px solid rgba(148,163,184,.25);
  }
  h1,h2,h3{font-weight:700;}

  .btn{
    border:none;
    padding:.6rem 1.2rem;
    border-radius:.75rem;
    cursor:pointer;
    font-size:.9rem;
    font-weight:600;
    transition:.15s;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.4rem;
  }
  .btn-main{
    background:linear-gradient(135deg,var(--accent),var(--accent-soft));
    color:#022c22;
  }
  .btn-main:hover{filter:brightness(1.1);}
  .btn-soft{
    background:rgba(15,23,42,.9);
    color:var(--text);
    border:1px solid rgba(148,163,184,.5);
  }
  .btn-soft:hover{background:rgba(15,23,42,1);}
  .btn-danger{
    background:var(--danger);
    color:#111827;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:.3rem;
    padding:.2rem .6rem;
    border-radius:999px;
    font-size:.7rem;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.6);
    color:var(--muted);
  }
  input,select,textarea{
    width:100%;
    padding:.5rem .7rem;
    border-radius:.5rem;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.5);
    color:var(--text);
    font-size:.9rem;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--accent);
  }
  .grid{display:grid;gap:1rem;}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr));}
  @media(max-width:768px){
    .grid-2{grid-template-columns:1fr;}
    .overlay{padding:.75rem;}
    .glass{padding:1rem;}
  }
  .card{
    background:var(--card);
    border-radius:1rem;
    padding:1rem;
    border:1px solid rgba(148,163,184,.25);
  }
  .scroll-y{
    max-height:380px;
    overflow-y:auto;
    padding-right:.4rem;
  }
  .scroll-y::-webkit-scrollbar{width:.35rem;}
  .scroll-y::-webkit-scrollbar-thumb{
    background:rgba(148,163,184,.7);
    border-radius:999px;
  }

  .jury-grid{
    display:grid;
    grid-template-columns:repeat(6,minmax(0,1fr));
    gap:.3rem;
  }
  @media(max-width:768px){
    .jury-grid{grid-template-columns:repeat(4,minmax(0,1fr));}
  }
  .jury-cell{
    background:rgba(15,23,42,.95);
    border-radius:.6rem;
    padding:.3rem .4rem;
    text-align:center;
    font-size:.7rem;
    border:1px solid rgba(148,163,184,.4);
    color:var(--muted);
  }
  .jury-cell span{display:block;font-size:.68rem;}
  .jury-guilty{background:rgba(248,113,113,.17);border-color:rgba(248,113,113,.7);color:#fecaca;}
  .jury-not{background:rgba(52,211,153,.18);border-color:rgba(52,211,153,.8);color:#bbf7d0;}

  .speech-bubble{
    position:relative;
    padding:1rem 1rem .9rem 1rem;
    border-radius:1rem;
    background:rgba(15,23,42,.97);
    border:1px solid rgba(148,163,184,.5);
    font-size:.9rem;
    line-height:1.5;
  }
  .speech-header{
    display:flex;
    align-items:center;
    gap:.6rem;
    margin-bottom:.35rem;
  }
  .avatar{
    width:2.4rem;
    height:2.4rem;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.2rem;
    font-weight:700;
    color:#f9fafb;
  }
  .avatar-acc{background:linear-gradient(135deg,#fecaca,#b91c1c);}
  .avatar-def{background:linear-gradient(135deg,#bbf7d0,#15803d);}
  .fade{animation:fadeIn .35s ease-out;}
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(4px);}
    to{opacity:1;transform:translateY(0);}
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:1rem;
    gap:.75rem;
  }
  .topbar span{font-size:.85rem;color:var(--muted);}

  .mode-pill{
    padding:.25rem .65rem;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.5);
    font-size:.7rem;
    color:var(--muted);
  }

  /* menu inicial estilo B */
  .menu-stack{
    display:flex;
    flex-direction:column;
    gap:.6rem;
    margin-top:1.1rem;
  }
  .menu-btn{
    width:100%;
    justify-content:flex-start;
    font-size:.95rem;
    padding:.7rem 1rem;
  }
  .menu-btn span.icon{font-size:1.1rem;}

  .bar-wrap{
    width:100%;
    height:.35rem;
    border-radius:999px;
    background:rgba(148,163,184,.3);
    overflow:hidden;
  }
  .bar-fill{
    height:100%;
    border-radius:999px;
  }
</style>
</head>
<body>

<!-- ========== TELA 1 ‚Äì CAPA / MENU INICIAL (ESTILO B) ========== -->
<section id="screen-splash" class="screen bg-splash active">
  <div class="overlay">
    <div class="container" style="display:flex;align-items:flex-end;min-height:100vh;">
      <div class="glass" style="max-width:420px;margin-bottom:1.5rem;">
        <div class="badge">Vale Produ√ß√£o apresenta</div>
        <h1 style="font-size:1.9rem;margin-top:.6rem;margin-bottom:.15rem;">
          Tribunal ‚Äì Simulador de Juiz
        </h1>
        <p style="font-size:.9rem;color:var(--muted);">
          Viva a experi√™ncia de julgar casos, construir uma carreira jur√≠dica
          e treinar decis√µes com base em provas, como em um tribunal real.
        </p>

        <div class="menu-stack">
          <button class="btn btn-main menu-btn" onclick="startFromMenu('new')">
            <span class="icon">‚ñ∂</span>
            <span>Jogar</span>
          </button>
          <button class="btn btn-soft menu-btn" onclick="startFromMenu('study')">
            <span class="icon">üéì</span>
            <span>Modo Estudo</span>
          </button>
          <button class="btn btn-soft menu-btn" onclick="startFromMenu('career')">
            <span class="icon">‚öñ</span>
            <span>Carreira Jur√≠dica</span>
          </button>
          <button class="btn btn-soft menu-btn" onclick="startFromMenu('continue')">
            <span class="icon">üìÅ</span>
            <span>Continuar Jogo</span>
          </button>
        </div>

        <p style="margin-top:.7rem;font-size:.75rem;color:var(--muted);">
          Quando seu desempenho for alto em Modo Carreira, voc√™ poder√° se candidatar ao
          <strong>STJ</strong> pelo bot√£o que aparece no Escrit√≥rio.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 2 ‚Äì TUTORIAL SALVAMENTO ========== -->
<section id="screen-tutorial" class="screen">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <h2>Tutorial r√°pido de salvamento</h2>
        <p style="margin-top:.5rem;font-size:.9rem;color:var(--muted);">
          Este simulador salva seus dados <strong>no pr√≥prio navegador (localStorage)</strong> e tamb√©m
          permite exportar um arquivo <strong>.juizsave</strong> para backup ou para jogar em outro computador.
        </p>
        <div class="grid grid-2" style="margin-top:1rem;">
          <div class="card">
            <h3 style="font-size:1rem;margin-bottom:.4rem;">Salvamento autom√°tico</h3>
            <ul style="font-size:.85rem;color:var(--muted);line-height:1.5;margin-left:1rem;">
              <li>Ao terminar um julgamento.</li>
              <li>Ao voltar para o Escrit√≥rio.</li>
              <li>Ao concluir o exame do STJ.</li>
            </ul>
          </div>
          <div class="card">
            <h3 style="font-size:1rem;margin-bottom:.4rem;">Salvar / Exportar manualmente</h3>
            <ul style="font-size:.85rem;color:var(--muted);line-height:1.5;margin-left:1rem;">
              <li>No Escrit√≥rio, use <strong>‚ÄúSalvar agora‚Äù</strong> para for√ßar o salvamento.</li>
              <li>Use <strong>‚ÄúExportar Save‚Äù</strong> para baixar um arquivo com o progresso.</li>
              <li>Use <strong>‚ÄúImportar Save‚Äù</strong> para carregar um arquivo salvo anteriormente.</li>
            </ul>
          </div>
        </div>
        <p style="margin-top:1rem;font-size:.8rem;color:var(--muted);">
          Dica: em turmas, pe√ßa para os alunos exportarem o save ao final de cada aula, como se fosse ‚Äúentregar a atividade‚Äù.
        </p>
        <div style="margin-top:1.2rem;display:flex;justify-content:space-between;gap:.6rem;">
          <button class="btn btn-soft" onclick="goTo('splash')">Voltar</button>
          <button class="btn btn-main" onclick="goTo('login')">Entendi, continuar</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 3 ‚Äì LOGIN / PERFIS ========== -->
<section id="screen-login" class="screen">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <div class="badge">Tribunal ‚Äì Simulador de Juiz 4.2</div>
            <h2 style="margin-top:.3rem;">Perfis de juiz</h2>
          </div>
          <span>Os perfis ficam salvos neste navegador.</span>
        </div>
        <div class="grid grid-2">
          <div class="card">
            <h3 style="font-size:1rem;margin-bottom:.5rem;">Entrar ou criar perfil</h3>
            <label style="font-size:.8rem;color:var(--muted);">Usu√°rio</label>
            <input id="login-name" placeholder="ex.: Dra. Maria, Prof. Jo√£o..." />
            <label style="font-size:.8rem;color:var(--muted);margin-top:.6rem;">Senha (opcional)</label>
            <input id="login-pass" type="password" />
            <div style="display:flex;gap:.5rem;margin-top:.9rem;">
              <button class="btn btn-main" onclick="enterProfile()">Entrar / Criar perfil</button>
              <button class="btn btn-danger" onclick="removeProfile()">Remover perfil</button>
            </div>

            <div style="margin-top:1.1rem;">
              <div style="font-size:.8rem;color:var(--muted);margin-bottom:.25rem;">Perfis encontrados:</div>
              <div id="profile-list" style="display:flex;flex-wrap:wrap;gap:.4rem;font-size:.8rem;"></div>
            </div>
          </div>
          <div class="card">
            <h3 style="font-size:1rem;margin-bottom:.5rem;">Backup de save</h3>
            <button class="btn btn-soft" onclick="exportAllSaves()">Exportar todos os saves</button>
            <p style="font-size:.8rem;color:var(--muted);margin-top:.4rem;">
              Gera um arquivo com todos os perfis salvos neste navegador.
            </p>
            <hr style="border:none;border-top:1px solid rgba(148,163,184,.4);margin:.9rem 0;" />
            <label class="btn btn-soft" style="display:inline-block;cursor:pointer;">
              Importar arquivo de save
              <input id="import-file" type="file" accept=".juizsave" style="display:none;" />
            </label>
            <p style="font-size:.8rem;color:var(--muted);margin-top:.4rem;">
              Use este recurso para restaurar uma turma ou migrar entre computadores.
            </p>
          </div>
        </div>
        <div style="margin-top:1rem;text-align:right;">
          <button class="btn btn-soft" onclick="goTo('splash')">Voltar ao menu inicial</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 4 ‚Äì MODO (CARREIRA / ESTUDO) ========== -->
<section id="screen-mode" class="screen">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <h2>Escolha o modo de jogo</h2>
            <span id="mode-user-label" style="display:block;margin-top:.2rem;"></span>
          </div>
          <span>Voc√™ pode alternar de modo a qualquer momento.</span>
        </div>
        <div class="grid grid-2">
          <div class="card">
            <div class="badge">Modo carreira</div>
            <h3 style="margin-top:.4rem;margin-bottom:.3rem;">Evolu√ß√£o como juiz</h3>
            <p style="font-size:.9rem;color:var(--muted);">
              Voc√™ come√ßa na primeira inst√¢ncia, julga casos simulados, acumula prest√≠gio,
              pode ser convidado ao STJ e gerar relat√≥rios semestrais de desempenho.
            </p>
            <button class="btn btn-main" style="margin-top:.7rem;" onclick="setMode('carreira')">
              Jogar em modo carreira
            </button>
          </div>
          <div class="card">
            <div class="badge">Modo estudo</div>
            <h3 style="margin-top:.4rem;margin-bottom:.3rem;">Treino de casos espec√≠ficos</h3>
            <p style="font-size:.9rem;color:var(--muted);">
              Escolha livremente tipos de casos, repita julgamentos, fa√ßa pausas e use o simulador
              como ferramenta did√°tica em sala de aula ou estudo individual.
            </p>
            <button class="btn btn-soft" style="margin-top:.7rem;" onclick="setMode('estudo')">
              Jogar em modo estudo
            </button>
          </div>
        </div>
        <div style="margin-top:1.1rem;text-align:right;">
          <button class="btn btn-soft" onclick="goTo('login')">Voltar ao login</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 5 ‚Äì ESCOLHA DO TRIBUNAL ========== -->
<section id="screen-court" class="screen">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <h2>Escolha o tribunal em que atuar√°</h2>
            <span id="court-user-label" style="display:block;margin-top:.2rem;font-size:.85rem;color:var(--muted);"></span>
          </div>
          <span id="mode-pill" class="mode-pill"></span>
        </div>
        <div class="grid grid-2">
          <div class="card">
            <h3>Criminal</h3>
            <p style="font-size:.85rem;color:var(--muted);margin-top:.2rem;">
              Crimes contra a pessoa e patrim√¥nio. J√∫ri popular nos crimes dolosos contra a vida,
              an√°lise de laudos, testemunhas e padr√£o ‚Äúal√©m de d√∫vida razo√°vel‚Äù.
            </p>
            <button class="btn btn-soft" style="margin-top:.6rem;" onclick="chooseCourt('criminal')">
              Atuar na vara criminal
            </button>
          </div>
          <div class="card">
            <h3>Fam√≠lia / C√≠vel</h3>
            <p style="font-size:.85rem;color:var(--muted);margin-top:.2rem;">
              Guarda, alimentos, visitas, div√≥rcio, medidas protetivas e interesses de crian√ßas
              e adolescentes, sob o crit√©rio do melhor interesse.
            </p>
            <button class="btn btn-soft" style="margin-top:.6rem;" onclick="chooseCourt('familia')">
              Atuar na vara de fam√≠lia
            </button>
          </div>
          <div class="card">
            <h3>Trabalhista</h3>
            <p style="font-size:.85rem;color:var(--muted);margin-top:.2rem;">
              V√≠nculo de emprego, verbas rescis√≥rias, horas extras, ass√©dio moral,
              responsabilidade do empregador e preponder√¢ncia probat√≥ria.
            </p>
            <button class="btn btn-soft" style="margin-top:.6rem;" onclick="chooseCourt('trabalhista')">
              Atuar na vara trabalhista
            </button>
          </div>
        </div>
        <div style="margin-top:1.1rem;text-align:right;">
          <button class="btn btn-soft" onclick="goTo('mode')">Voltar</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 6 ‚Äì ESCRIT√ìRIO / DASHBOARD ========== -->
<section id="screen-office" class="screen bg-office">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <div id="office-user" style="font-weight:600;"></div>
            <span id="office-court" style="display:block;margin-top:.15rem;"></span>
          </div>
          <div style="text-align:right;">
            <div style="font-size:.78rem;color:var(--muted);">IAJ (√çndice de Ader√™ncia Jur√≠dica)</div>
            <div id="office-iaj" style="font-size:1rem;font-weight:600;">0%</div>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- fila de processos -->
          <div class="card">
            <h3 style="font-size:.95rem;">Fila de processos</h3>
            <div id="office-queue" class="scroll-y" style="margin-top:.6rem;"></div>
          </div>

          <!-- m√©tricas, carreira, salvar -->
          <div class="card">
            <h3 style="font-size:.95rem;">M√©tricas & carreira</h3>
            <div id="office-metrics" style="margin-top:.4rem;font-size:.85rem;color:var(--muted);"></div>

            <div style="margin-top:.5rem;">
              <div style="font-size:.78rem;color:var(--muted);margin-bottom:.25rem;">Reputa√ß√£o p√∫blica</div>
              <div class="bar-wrap"><div id="bar-pub" class="bar-fill" style="width:0;background:#38bdf8;"></div></div>

              <div style="font-size:.78rem;color:var(--muted);margin-top:.4rem;margin-bottom:.25rem;">Reputa√ß√£o t√©cnica</div>
              <div class="bar-wrap"><div id="bar-tec" class="bar-fill" style="width:0;background:#22c55e;"></div></div>

              <div style="font-size:.78rem;color:var(--muted);margin-top:.4rem;margin-bottom:.25rem;">Reputa√ß√£o institucional</div>
              <div class="bar-wrap"><div id="bar-inst" class="bar-fill" style="width:0;background:#eab308;"></div></div>
            </div>

            <div style="margin-top:.9rem;display:flex;flex-wrap:wrap;gap:.5rem;">
              <button class="btn btn-soft" onclick="manualSave()">Salvar agora</button>
              <button class="btn btn-soft" onclick="exportCurrentSave()">Exportar Save</button>
              <label class="btn btn-soft" style="cursor:pointer;">
                Importar Save
                <input id="office-import" type="file" accept=".juizsave" style="display:none;" />
              </label>
            </div>

            <hr style="border:none;border-top:1px solid rgba(148,163,184,.25);margin:.9rem 0;" />

            <h3 style="font-size:.95rem;">Carreira</h3>
            <p id="office-career" style="margin-top:.3rem;font-size:.83rem;color:var(--muted);"></p>
            <button id="btn-stj" class="btn btn-main" style="margin-top:.7rem;display:none;" onclick="openStjExam()">
              Candidatar-se ao STJ (exame r√°pido)
            </button>

            <button class="btn btn-soft" style="margin-top:.7rem;" onclick="openReport()">
              Relat√≥rio semestral
            </button>

            <button class="btn btn-soft" style="margin-top:.7rem;" onclick="goTo('mode')">
              Trocar modo / tribunal
            </button>
          </div>
        </div>

        <div id="office-selected" class="card" style="margin-top:1rem;display:none;"></div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 7 ‚Äì JULGAMENTO ========== -->
<section id="screen-trial" class="screen bg-court">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <h2>Sala de Julgamento</h2>
            <span id="trial-case-title"></span>
          </div>
          <div style="display:flex;gap:.4rem;flex-wrap:wrap;justify-content:flex-end;">
            <span id="trial-user-label" style="font-size:.8rem;color:var(--muted);"></span>
            <span id="trial-mode-pill" class="mode-pill"></span>
          </div>
        </div>

        <div class="grid grid-2">
          <!-- lado esquerdo: falas e perguntas -->
          <div class="card">
            <div style="display:flex;flex-wrap:wrap;gap:.4rem;margin-bottom:.6rem;">
              <button class="btn btn-soft" onclick="speakAccusation()">Palavra √† Acusa√ß√£o (A)</button>
              <button class="btn btn-soft" onclick="speakDefense()">Ouvir Defesa (D)</button>
              <button class="btn btn-main" onclick="finishTrial(true)">Condenar (C)</button>
              <button class="btn btn-soft" onclick="finishTrial(false)">Absolver (B)</button>
              <button class="btn btn-soft" onclick="backToOffice()">Voltar</button>
            </div>

            <div id="trial-speeches" class="scroll-y" style="max-height:260px;"></div>

            <div class="card" style="margin-top:.6rem;">
              <div style="font-size:.8rem;color:var(--muted);margin-bottom:.25rem;">
                Pergunta do juiz‚Ä¶ (Enter) ‚Äî A: acusa√ß√£o, D: defesa (atalhos para as falas iniciais).
              </div>
              <div style="display:flex;gap:.4rem;align-items:center;">
                <input id="trial-question" placeholder="Ex.: detalhar o laudo, contradi√ß√µes, din√¢mica dos fatos, dolo, culpa, nulidade..." />
                <button class="btn btn-soft" onclick="askQuestion()">Perguntar</button>
              </div>
            </div>

            <div class="card" style="margin-top:.6rem;">
              <h3 style="font-size:.9rem;margin-bottom:.25rem;">J√∫ri Popular (12)</h3>
              <div class="jury-grid" id="jury-grid"></div>
              <button id="btn-deliberar" class="btn btn-soft" style="margin-top:.5rem;" onclick="deliberateJury()">
                Iniciar Delibera√ß√£o
              </button>
            </div>
          </div>

          <!-- lado direito: dossi√™ -->
          <div class="card">
            <h3 style="font-size:.9rem;">Dossi√™ (Provas)</h3>
            <div id="trial-dossier" class="scroll-y" style="margin-top:.5rem;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 8 ‚Äì EXAME STJ ========== -->
<section id="screen-stj" class="screen bg-stj">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <div>
            <h2>Exame de promo√ß√£o ao STJ</h2>
            <span style="font-size:.85rem;color:var(--muted);">
              Responda √†s quest√µes objetivas. √â uma simula√ß√£o simplificada do processo de promo√ß√£o.
            </span>
          </div>
          <span id="stj-user-label" style="font-size:.8rem;color:var(--muted);"></span>
        </div>
        <div id="stj-questions" class="card"></div>
        <div style="margin-top:1rem;display:flex;justify-content:space-between;">
          <button class="btn btn-soft" onclick="cancelStjExam()">Cancelar</button>
          <button class="btn btn-main" onclick="submitStjExam()">Enviar respostas</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ========== TELA 9 ‚Äì RELAT√ìRIO SEMESTRAL (SIMPLIFICADO) ========== -->
<section id="screen-report" class="screen">
  <div class="overlay">
    <div class="container">
      <div class="glass">
        <div class="topbar">
          <h2>Relat√≥rio semestral de desempenho</h2>
          <span id="report-user-label" style="font-size:.8rem;color:var(--muted);"></span>
        </div>
        <div id="report-content" class="card"></div>
        <div style="margin-top:1rem;text-align:right;">
          <button class="btn btn-soft" onclick="goTo('office')">Voltar ao Escrit√≥rio</button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ============ ESTADO GLOBAL ============ */
let currentScreen = "splash";
let currentProfile = null;
let profiles = {};
let currentMode = "carreira";
let currentCourt = null;
let currentCases = [];
let currentCase = null;
let juryState = [];
let stjQuestions = [];
let trialRoles = null; // personalidades de acusa√ß√£o/defesa neste caso
let startAction = "new";
const STORAGE_KEY = "juizsimulator_v42_profiles";

/* PERSONALIDADES SIMPLES PARA ACUSA√á√ÉO/DEFESA */
const PROMOTOR_PROFILES = ["t√©cnico","rigoroso","conciliador"];
const DEFESA_PROFILES   = ["garantista","emocional","pragm√°tica"];

/* ============ MENU INICIAL (B) ============ */
function startFromMenu(action){
  startAction = action;
  if(action === "continue"){
    goTo("login");
  }else{
    goTo("tutorial");
  }
}

/* ============ UTIL ============ */
function goTo(screen){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById("screen-"+screen);
  if(el) el.classList.add("active");
  currentScreen = screen;
  if(screen==="login") renderProfileList();
  if(screen==="mode") updateModeScreen();
  if(screen==="court") updateCourtScreen();
  if(screen==="office") renderOffice();
}
function loadProfiles(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) profiles = JSON.parse(raw);
  }catch(e){profiles={};}
}
function saveProfiles(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(profiles));
}
loadProfiles();

/* ============ STATS DEFAULT / MERGE ============ */
function defaultStats(){
  return {
    julgados:0,
    acertos:0,
    prestigio:0,
    semestre:1,
    cargo:"Juiz Substituto",
    reputacaoPublica:50,
    reputacaoTecnica:50,
    reputacaoInstitucional:50,
    stjAtivo:false
  };
}
function getStats(){
  if(!currentProfile) return defaultStats();
  const p=profiles[currentProfile];
  if(!p.stats) p.stats=defaultStats();
  else p.stats = {...defaultStats(), ...p.stats};
  return p.stats;
}
function setStats(stats){
  if(!currentProfile) return;
  profiles[currentProfile].stats = {...defaultStats(), ...stats};
  saveProfiles();
}

/* ============ LOGIN ============ */
function renderProfileList(){
  const wrap = document.getElementById("profile-list");
  wrap.innerHTML = "";
  Object.keys(profiles).forEach(name=>{
    const b = document.createElement("button");
    b.className="btn btn-soft";
    b.textContent=name;
    b.onclick=()=>{
      document.getElementById("login-name").value=name;
      document.getElementById("login-pass").value="";
    };
    wrap.appendChild(b);
  });
}
document.getElementById("import-file").addEventListener("change", e=>{
  const f=e.target.files[0];
  if(!f) return;
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(data && data.profiles){
        profiles=data.profiles;
        saveProfiles();
        alert("Saves importados com sucesso.");
        renderProfileList();
      }
    }catch(err){alert("Arquivo inv√°lido.");}
  };
  rd.readAsText(f);
});
function exportAllSaves(){
  const blob=new Blob([JSON.stringify({profiles},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="tribunal_saves.juizsave";
  document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
}
function enterProfile(){
  const name=document.getElementById("login-name").value.trim();
  const pass=document.getElementById("login-pass").value;
  if(!name){alert("Informe um nome de usu√°rio.");return;}
  if(!profiles[name]){
    profiles[name]={password:pass||null, stats:defaultStats(), saves:{}};
  }else if(profiles[name].password && profiles[name].password!==pass){
    alert("Senha incorreta para este perfil.");return;
  }
  currentProfile=name;
  saveProfiles();

  const prof=profiles[name];
  const hasSave = prof.saves && prof.saves.main;

  if(startAction==="continue" && hasSave){
    restoreFromSave(prof.saves.main);
    goTo("office");
  }else{
    if(startAction==="study") currentMode="estudo";
    if(startAction==="career") currentMode="carreira";
    goTo("mode");
  }
}
function removeProfile(){
  const name=document.getElementById("login-name").value.trim();
  if(!name || !profiles[name]){alert("Selecione um perfil existente.");return;}
  if(confirm("Remover perfil "+name+"? Isso apagar√° todos os dados deste usu√°rio.")){
    delete profiles[name];
    saveProfiles();
    currentProfile=null;
    renderProfileList();
    alert("Perfil removido.");
  }
}

/* ============ MODO / TRIBUNAL ============ */
function updateModeScreen(){
  document.getElementById("mode-user-label").textContent="Usu√°rio: "+(currentProfile||"‚Äî");
}
function setMode(mode){
  currentMode=mode;
  goTo("court");
}
function updateCourtScreen(){
  document.getElementById("court-user-label").textContent=
    "Usu√°rio: "+(currentProfile||"‚Äî")+" ‚Ä¢ Modo atual: "+(currentMode==="carreira"?"Carreira":"Estudo");
  document.getElementById("mode-pill").textContent=currentMode==="carreira"?"Modo carreira":"Modo estudo";
}
function chooseCourt(court){
  currentCourt=court;
  prepareCases();
  goTo("office");
}

/* ============ GERA√á√ÉO DE CASOS ============ */
function randomPick(arr){return arr[Math.floor(Math.random()*arr.length)];}
function prepareCases(){
  const baseCount=100;
  const cases=[];
  const crimes=["homic√≠dio simples","homic√≠dio qualificado","roubo armado","furto qualificado","les√£o corporal","viol√™ncia dom√©stica","tr√°fico de drogas","recepta√ß√£o","amea√ßa","estelionato"];
  const cenarios=["em bar","em resid√™ncia","em via p√∫blica","em condom√≠nio","em festa","em est√°dio de futebol","em transporte p√∫blico","em estacionamento","em escola","em ag√™ncia banc√°ria"];
  const fam=["guarda compartilhada","revis√£o de alimentos","regulamenta√ß√£o de visitas","div√≥rcio litigioso","aliena√ß√£o parental","ado√ß√£o","pens√£o avoenga","uni√£o est√°vel","medida protetiva","partilha de bens"];
  const trab=["horas extras","v√≠nculo de emprego x PJ","ass√©dio moral","adicional de insalubridade","ac√∫mulo de fun√ß√£o","equipara√ß√£o salarial","dano moral por acidente","justa causa discutida","intervalo intrajornada","desvio de fun√ß√£o"];

  for(let i=0;i<baseCount;i++){
    if(currentCourt==="criminal"){
      const crime=randomPick(crimes);
      const cenario=randomPick(cenarios);
      const titulo=crime.charAt(0).toUpperCase()+crime.slice(1)+" "+cenario;
      const provas=[
        {id:"E1",tipo:"boletim de ocorr√™ncia",conteudo:"Registro detalhado dos fatos em "+cenario+" envolvendo poss√≠vel "+crime+"."},
        {id:"E2",tipo:"laudo pericial",conteudo:"Per√≠cia descrevendo din√¢mica e compatibilidade das les√µes/objetos com a vers√£o apresentada."},
        {id:"E3",tipo:"depoimento de testemunha",conteudo:"Testemunha relata ter visto parte dos acontecimentos, com pontos convergentes e divergentes."},
        {id:"E4",tipo:"imagens de c√¢mera",conteudo:"Grava√ß√£o parcial do local, sem √°udio, mostrando movimenta√ß√£o antes e depois do fato."},
        {id:"E5",tipo:"antecedentes / certid√µes",conteudo:"Certid√µes criminais e outros documentos do r√©u."}
      ];
      cases.push({id:"C"+(i+1),tipo:"criminal",titulo,resumo:"Discuss√£o sobre "+crime+" ocorrido "+cenario+". R√©u apresenta vers√£o alternativa dos fatos.",provas,gabarito:{culpado:Math.random()<0.65,padrao:"alem_duvida"},status:"fila"});
    }else if(currentCourt==="familia"){
      const tema=randomPick(fam);
      const titulo=tema.charAt(0).toUpperCase()+tema.slice(1);
      const provas=[
        {id:"E1",tipo:"relat√≥rio psicossocial",conteudo:"Equipe t√©cnica avalia v√≠nculos afetivos, rotina e contexto familiar."},
        {id:"E2",tipo:"documentos de renda e despesas",conteudo:"Comprovantes de renda, gastos com moradia, escola, sa√∫de e transporte."},
        {id:"E3",tipo:"mensagens e e-mails",conteudo:"Trocas de mensagens que revelam conflitos de comunica√ß√£o e tentativas de acordo."},
      ];
      cases.push({id:"F"+(i+1),tipo:"familia",titulo,resumo:"Conflito de fam√≠lia envolvendo "+tema+". Avalia√ß√£o do melhor interesse da crian√ßa ou das partes vulner√°veis.",provas,gabarito:{culpado:false,padrao:"preponderancia"},status:"fila"});
    }else if(currentCourt==="trabalhista"){
      const tema=randomPick(trab);
      const titulo="A√ß√£o trabalhista sobre "+tema;
      const provas=[
        {id:"E1",tipo:"contrato / CTPS / recibos",conteudo:"Documentos formais de contrata√ß√£o, recibos de pagamento e anota√ß√µes em carteira."},
        {id:"E2",tipo:"registros de ponto / escala",conteudo:"Espelhos de ponto, controles de jornada e escalas de trabalho."},
        {id:"E3",tipo:"depoimento de colega",conteudo:"Testemunha descreve rotina, ordens recebidas e condi√ß√µes de trabalho."},
      ];
      cases.push({id:"T"+(i+1),tipo:"trabalhista",titulo,resumo:"Discuss√£o trabalhista envolvendo "+tema+".",provas,gabarito:{culpado:false,padrao:"preponderancia"},status:"fila"});
    }
  }
  currentCases=cases;
}

/* ============ ESCRIT√ìRIO ============ */
function computeIAJ(stats){
  if(!stats.julgados) return 0;
  return Math.round((stats.acertos/stats.julgados)*100);
}
function renderOffice(){
  const stats=getStats();
  const iaj=computeIAJ(stats);
  document.getElementById("office-user").textContent="Usu√°rio: "+currentProfile;
  const inst = stats.stjAtivo ? "STJ (simulado)" :
    (currentCourt==="criminal"?"Vara Criminal":currentCourt==="familia"?"Vara Fam√≠lia/C√≠vel":"Vara Trabalhista");
  document.getElementById("office-court").textContent="Inst√¢ncia: "+inst+
    " ‚Ä¢ Modo: "+(currentMode==="carreira"?"Carreira":"Estudo")+
    " ‚Ä¢ Cargo: "+stats.cargo;
  document.getElementById("office-iaj").textContent=iaj+"%";

  const qDiv=document.getElementById("office-queue");
  qDiv.innerHTML="";
  currentCases.filter(c=>c.status==="fila").slice(0,40).forEach(c=>{
    const el=document.createElement("div");
    el.className="card fade";
    el.style.marginBottom=".4rem";
    el.innerHTML=`<div style="font-weight:600;font-size:.9rem;">${c.titulo}</div>
      <div style="font-size:.8rem;color:var(--muted);margin-top:.15rem;">${c.resumo}</div>
      <div style="margin-top:.45rem;display:flex;gap:.4rem;flex-wrap:wrap;">
        <button class="btn btn-soft" onclick="readCase('${c.id}')">Ler</button>
        <button class="btn btn-main" onclick="startTrial('${c.id}')">Julgar</button>
      </div>`;
    qDiv.appendChild(el);
  });
  if(!qDiv.innerHTML) qDiv.textContent="Sem casos na fila deste tribunal.";

  const metrics=document.getElementById("office-metrics");
  metrics.innerHTML=`Casos julgados neste semestre simulado: <strong>${stats.julgados}</strong><br/>
    Acertos em rela√ß√£o ao gabarito simulado: <strong>${stats.acertos}</strong><br/>
    IAJ: <strong>${iaj}%</strong><br/>
    Prest√≠gio geral: <strong>${stats.prestigio}%</strong>`;

  // reputa√ß√µes
  document.getElementById("bar-pub").style.width=Math.min(100,stats.reputacaoPublica)+"%";
  document.getElementById("bar-tec").style.width=Math.min(100,stats.reputacaoTecnica)+"%";
  document.getElementById("bar-inst").style.width=Math.min(100,stats.reputacaoInstitucional)+"%";

  const career=document.getElementById("office-career");
  let comentario="In√≠cio de carreira.";
  if(stats.cargo==="Juiz Titular") comentario="J√° consolidado em primeira inst√¢ncia, com atua√ß√£o consistente.";
  if(stats.cargo==="Desembargador") comentario="Atua em grau recursal, com decis√µes que influenciam toda a regi√£o.";
  if(stats.cargo.includes("STJ")) comentario="Atua em corte superior, uniformizando a interpreta√ß√£o da legisla√ß√£o federal.";
  career.textContent=`Cargo atual: ${stats.cargo}. ${comentario}`;

  const canStj = currentMode==="carreira" && !stats.stjAtivo && iaj>=70 && stats.julgados>=20;
  document.getElementById("btn-stj").style.display=canStj?"inline-block":"none";

  const selDiv=document.getElementById("office-selected");
  selDiv.style.display="none";

  document.getElementById("office-import").onchange=e=>{
    const f=e.target.files[0];if(!f) return;
    const rd=new FileReader();
    rd.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(data && data.profiles && data.profiles[currentProfile]){
          profiles[currentProfile]=data.profiles[currentProfile];
          saveProfiles();
          alert("Save importado para o usu√°rio atual.");
          renderOffice();
        }else alert("Arquivo n√£o cont√©m dados deste usu√°rio.");
      }catch(err){alert("Arquivo inv√°lido.");}
    };
    rd.readAsText(f);
  };
  autoSave();
}
function readCase(id){
  const c=currentCases.find(x=>x.id===id);
  if(!c) return;
  const selDiv=document.getElementById("office-selected");
  selDiv.style.display="block";
  const provasList=c.provas.map(p=>`<li>[${p.id}] <strong>${p.tipo}</strong>: ${p.conteudo}</li>`).join("");
  selDiv.innerHTML=`
    <h3 style="font-size:.95rem;">Processo selecionado</h3>
    <div style="font-size:.9rem;font-weight:600;margin-top:.25rem;">${c.titulo}</div>
    <div style="font-size:.85rem;color:var(--muted);margin-top:.15rem;">${c.resumo}</div>
    <div style="font-size:.83rem;color:var(--muted);margin-top:.5rem;">Provas:</div>
    <ul style="font-size:.83rem;margin-left:1rem;margin-top:.2rem;">${provasList}</ul>
  `;
}
function startTrial(id){
  currentCase=currentCases.find(x=>x.id===id);
  if(!currentCase){alert("Caso n√£o encontrado.");return;}
  juryState=Array.from({length:12},(_,i)=>({id:i+1,voto:null,certeza:0}));
  // gera personalidades para este caso
  trialRoles={
    acusacao: randomPick(PROMOTOR_PROFILES),
    defesa:  randomPick(DEFESA_PROFILES)
  };
  renderJury();
  renderTrial();
  goTo("trial");
}

/* ============ JULGAMENTO / FALAS ============ */
function renderTrial(){
  document.getElementById("trial-case-title").textContent=currentCase.titulo;
  const stats=getStats();
  let instLabel = stats.stjAtivo ? "Corte Superior (STJ simulado)" :
    (currentCourt==="criminal"?"Vara Criminal":currentCourt==="familia"?"Vara Fam√≠lia/C√≠vel":"Vara Trabalhista");
  document.getElementById("trial-user-label").textContent="Juiz: "+currentProfile+" ‚Ä¢ "+instLabel;
  document.getElementById("trial-mode-pill").textContent=currentMode==="carreira"?"Modo carreira":"Modo estudo";

  const dossier=document.getElementById("trial-dossier");
  dossier.innerHTML="";
  currentCase.provas.forEach(p=>{
    const el=document.createElement("div");
    el.className="card";
    el.style.marginBottom=".4rem";
    el.innerHTML=`<div style="font-size:.8rem;color:var(--muted);">[${p.id}] ${p.tipo}</div>
      <div style="font-size:.86rem;margin-top:.1rem;">${p.conteudo}</div>`;
    dossier.appendChild(el);
  });

  document.getElementById("trial-speeches").innerHTML="";
  document.getElementById("trial-question").value="";
  document.getElementById("btn-deliberar").disabled=false;
}
function addSpeech(side,text){
  const wrap=document.getElementById("trial-speeches");
  const card=document.createElement("div");
  card.className="speech-bubble fade";
  const isAcc=side==="acusacao";
  const avatarClass=isAcc?"avatar avatar-acc":"avatar avatar-def";
  const sideLabel=isAcc?"Acusa√ß√£o":"Defesa";
  const role = trialRoles ? trialRoles[side] : null;
  const roleLabel = role ? (" ‚Ä¢ perfil: "+role) : "";
  card.innerHTML=`<div class="speech-header">
      <div class="${avatarClass}">${isAcc?"AC":"DF"}</div>
      <div>
        <div style="font-size:.78rem;color:${isAcc?"#fecaca":"#bbf7d0"};">${sideLabel}${roleLabel}</div>
        <div style="font-size:.75rem;color:var(--muted);">fala estruturada com base nas provas</div>
      </div>
    </div>
    <div class="speech-text" style="font-size:.86rem;line-height:1.6;white-space:pre-wrap;"></div>`;
  wrap.appendChild(card);
  typeWriter(card.querySelector(".speech-text"),text,14);
  wrap.scrollTop=wrap.scrollHeight;
}
function typeWriter(el,text,speed){
  el.textContent="";
  let i=0;
  const id=setInterval(()=>{
    el.textContent+=text.charAt(i);
    i++;
    if(i>=text.length) clearInterval(id);
  },speed);
}

/* falas iniciais com personalidade */
function buildSpeech(side){
  const provas=currentCase.provas;
  const ids=provas.map(p=>"["+p.id+"]").join(", ");
  const role = trialRoles ? trialRoles[side] : null;
  const tipo=currentCase.tipo;

  if(side==="acusacao"){
    if(role==="t√©cnico"){
      return `ACUSA√á√ÉO ‚Äì perfil t√©cnico:

Com base nas provas constantes dos autos, especialmente ${ids}, a acusa√ß√£o destaca a coer√™ncia interna do conjunto probat√≥rio. O laudo pericial, os depoimentos e os documentos apontam para a mesma dire√ß√£o e refor√ßam a narrativa da den√∫ncia.

No contexto do processo ${tipo==="criminal"?"criminal, exige-se um padr√£o de 'al√©m de d√∫vida razo√°vel'":"c√≠vel, em que basta a preponder√¢ncia da prova"}, entende-se que esses elementos s√£o suficientes para a proced√™ncia da pretens√£o acusat√≥ria.`;
    }
    if(role==="rigoroso"){
      return `ACUSA√á√ÉO ‚Äì perfil rigoroso:

As provas ${ids} evidenciam um cen√°rio de alta gravidade. A acusa√ß√£o ressalta que, diante da soma de laudo, testemunhos e registros formais, a vers√£o defensiva n√£o passa de tentativa de afastar responsabilidade.

A leitura sistem√°tica dos autos afasta qualquer d√∫vida razo√°vel e demonstra que a resposta estatal precisa ser firme, sob pena de descredibilizar a fun√ß√£o protetiva do Direito.`;
    }
    if(role==="conciliador"){
      return `ACUSA√á√ÉO ‚Äì perfil conciliador:

Embora as provas principais sejam ${ids}, a acusa√ß√£o reconhece que existem nuances e aspectos humanos relevantes. Ainda assim, o conjunto dos autos indica responsabilidade da parte acusada, dentro dos limites legais.

A atua√ß√£o ministerial n√£o ignora fatores sociais e familiares, mas lembra que a responsabiliza√ß√£o adequada tamb√©m √© instrumento de pacifica√ß√£o e preven√ß√£o de novos conflitos.`;
    }
    // fallback
    return `ACUSA√á√ÉO:

Com base em ${ids}, a acusa√ß√£o sustenta que o conjunto probat√≥rio √© suficiente para a condena√ß√£o, atendendo ao padr√£o exigido para o caso.`;
  }else{
    if(role==="garantista"){
      return `DEFESA ‚Äì perfil garantista:

A defesa parte do princ√≠pio de que nenhuma condena√ß√£o pode se sustentar sem prova robusta e consistente. Ao analisar ${ids}, percebe-se que h√° contradi√ß√µes, lacunas e pontos n√£o esclarecidos.

No √¢mbito ${tipo==="criminal"?"penal, a d√∫vida razo√°vel imp√µe a absolvi√ß√£o":"c√≠vel, a parte adversa n√£o se desincumbiu plenamente do √¥nus probat√≥rio"}. Assim, a solu√ß√£o mais alinhada √†s garantias fundamentais √© a decis√£o favor√°vel ao acusado / parte autora.`;
    }
    if(role==="emocional"){
      return `DEFESA ‚Äì perfil emocional:

Al√©m dos aspectos t√©cnicos, a defesa chama aten√ß√£o para a dimens√£o humana deste processo. As provas ${ids}, quando lidas com sensibilidade, revelam um contexto de fragilidade, medo e conflito intenso.

Em meio a tantas vers√µes, n√£o √© poss√≠vel afirmar com seguran√ßa que a responsabilidade recaia integralmente sobre o acusado. Diante disso, a defesa pede que a decis√£o leve em conta n√£o s√≥ a letra fria da lei, mas tamb√©m a realidade concreta vivida pelas pessoas envolvidas.`;
    }
    if(role==="pragm√°tica"){
      return `DEFESA ‚Äì perfil pragm√°tico:

A defesa se concentra naquilo que pode ser comprovado de forma objetiva. Ao examinar ${ids}, percebe-se que parte das alega√ß√µes adversas n√£o encontra apoio s√≥lido nas provas produzidas.

Considerando o padr√£o probat√≥rio aplic√°vel, o √¥nus da prova e a coer√™ncia das vers√µes, a solu√ß√£o mais racional √© afastar a pretens√£o acusat√≥ria ou, ao menos, mitig√°-la substancialmente.`;
    }
    return `DEFESA:

Utilizando as provas ${ids}, a defesa enfatiza as contradi√ß√µes, lacunas e d√∫vidas razo√°veis presentes na reconstru√ß√£o dos fatos, sustentando solu√ß√£o favor√°vel ao acusado / parte autora.`;
  }
}
function speakAccusation(){
  addSpeech("acusacao",buildSpeech("acusacao"));
}
function speakDefense(){
  addSpeech("defesa",buildSpeech("defesa"));
}

/* Perguntas livres do juiz com resposta mais inteligente */
function answerQuestionFor(side,question){
  question=question.toLowerCase();
  const p=currentCase.provas;
  let foco=null;
  if(question.includes("laudo")||question.includes("per√≠cia")) foco=p.find(x=>x.tipo.includes("laudo"))||p[1];
  else if(question.includes("testemunh")) foco=p.find(x=>x.tipo.includes("testemunha"))||p[2];
  else if(question.includes("c√¢mera")||question.includes("imagem")||question.includes("video")) foco=p.find(x=>x.tipo.includes("imagens"))||p[3];
  else if(question.includes("contradi")||question.includes("vers√£o")) foco=p.find(x=>x.tipo.includes("depoimento"))||p[2];
  else foco=p[0];

  const tipo=currentCase.tipo;
  const role = trialRoles ? trialRoles[side] : null;

  if(side==="acusacao"){
    let base = `ACUSA√á√ÉO ‚Äì resposta √† pergunta do ju√≠zo:\n\n`;
    base += `A partir de ${foco ? "["+foco.id+"] "+foco.tipo : "todas as provas relevantes"}, a acusa√ß√£o entende que o quadro probat√≥rio permanece consistente com a tese acusat√≥ria. `;
    if(question.includes("dolo")||question.includes("inten√ß√£o")){
      base += `Os elementos subjetivos (como falas, contexto pr√©vio e modo de agir) indicam que a conduta n√£o foi um mero acidente, mas revela inten√ß√£o ou, ao menos, assun√ß√£o consciente do risco. `;
    }
    if(question.includes("culpa")||question.includes("neglig")){
      base += `Ainda que n√£o se fale em dolo direto, a maneira como a situa√ß√£o foi conduzida revela descuido, imprud√™ncia ou neglig√™ncia incompat√≠veis com a cautela exigida. `;
    }
    if(question.includes("contradi")||question.includes("vers√µes")){
      base += `As varia√ß√µes pontuais de relato s√£o explic√°veis pelo tempo e pela emo√ß√£o do fato, sem comprometer o eixo central da narrativa, que se mant√©m firme em apontar a responsabilidade do acusado. `;
    }
    base += tipo==="criminal"
      ? `No padr√£o ‚Äúal√©m de d√∫vida razo√°vel‚Äù, tais elementos s√£o suficientes para afastar teses meramente especulativas e autorizar a condena√ß√£o.`
      : `No campo n√£o penal, a leitura conjunta das provas refor√ßa a proced√™ncia da pretens√£o formulada pela parte autora/MP.`;
    return base;
  }else{
    let base = `DEFESA ‚Äì resposta √† pergunta do ju√≠zo:\n\n`;
    base += `Analisando com aten√ß√£o ${foco ? "["+foco.id+"] "+foco.tipo : "os elementos trazidos aos autos"}, a defesa destaca que ainda subsistem pontos obscuros e aspectos n√£o totalmente esclarecidos. `;
    if(question.includes("dolo")||question.includes("inten√ß√£o")){
      base += `N√£o h√° elementos firmes o bastante para afirmar, com seguran√ßa, que o acusado agiu com inten√ß√£o manifesta de produzir o resultado narrado. `;
    }
    if(question.includes("culpa")||question.includes("neglig")){
      base += `Mesmo sob a √≥tica da culpa, √© necess√°rio cautela: o contexto pode indicar um conjunto de circunst√¢ncias at√≠picas, em que a previsibilidade do resultado n√£o √© t√£o evidente quanto sugere a acusa√ß√£o. `;
    }
    if(question.includes("contradi")||question.includes("vers√µes")){
      base += `As diverg√™ncias entre depoimentos mostram que a reconstru√ß√£o dos fatos n√£o √© linear. Essas contradi√ß√µes, em vez de serem minimizadas, devem pesar em favor da parte acusada/autor, pois enfraquecem a seguran√ßa exigida para uma conclus√£o condenat√≥ria. `;
    }
    base += tipo==="criminal"
      ? `Diante disso, a defesa insiste que a d√∫vida razo√°vel persiste, o que imp√µe solu√ß√£o absolut√≥ria, em respeito ao princ√≠pio in dubio pro reo.`
      : `No √¢mbito n√£o penal, a vers√£o apresentada pela parte defendida se mostra, ao menos, t√£o plaus√≠vel quanto a adversa, o que afasta a preponder√¢ncia necess√°ria para acolher integralmente a pretens√£o contr√°ria.`;
    if(role==="emocional"){
      base += `\n\nAl√©m disso, a defesa chama aten√ß√£o para o impacto humano de uma condena√ß√£o precipitada, lembrando que o processo envolve pessoas reais, com hist√≥rias e fragilidades, que n√£o podem ser reduzidas a meros n√∫meros estat√≠sticos.`;
    }
    return base;
  }
}
function askQuestion(){
  const q=document.getElementById("trial-question").value.trim();
  if(!q) return;
  const target=Math.random()<0.5?"acusacao":"defesa";
  const resp=answerQuestionFor(target,q);
  addSpeech(target,resp);
  document.getElementById("trial-question").value="";
}

/* J√∫ri */
function renderJury(){
  const grid=document.getElementById("jury-grid");
  grid.innerHTML="";
  juryState.forEach(j=>{
    const el=document.createElement("div");
    let cls="jury-cell";
    let label="J"+j.id.toString().padStart(2,"0");
    let extra="";
    if(j.voto===true){cls+=" jury-guilty";extra="Culpado üòê";}
    else if(j.voto===false){cls+=" jury-not";extra="Absolver üôÇ";}
    el.className=cls;
    el.innerHTML=`${label}<span>${extra}</span>`;
    grid.appendChild(el);
  });
}
function deliberateJury(){
  juryState=juryState.map(j=>{
    const certeza=Math.round(50+Math.random()*45);
    const voto=Math.random()<0.56;
    return {...j,certeza,voto};
  });
  renderJury();
  document.getElementById("btn-deliberar").disabled=true;
}

/* Finaliza√ß√£o do julgamento */
function registrarVeredito(decisaoCulpado){
  const stats=getStats();
  stats.julgados++;
  if(currentCase.tipo==="criminal"){
    const correto = (decisaoCulpado===!!currentCase.gabarito.culpado);
    if(correto){
      stats.acertos++;
      stats.reputacaoTecnica = Math.min(100,stats.reputacaoTecnica+2);
      stats.reputacaoInstitucional = Math.min(100,stats.reputacaoInstitucional+1.5);
    }else{
      stats.reputacaoTecnica = Math.max(0,stats.reputacaoTecnica-1);
    }
  }else{
    stats.acertos+=1;
    stats.reputacaoTecnica = Math.min(100,stats.reputacaoTecnica+0.5);
  }
  // reputa√ß√£o p√∫blica varia levemente, simulando rea√ß√£o da sociedade
  stats.reputacaoPublica = Math.min(100,Math.max(0,stats.reputacaoPublica + (Math.random()*4-2)));
  stats.prestigio=Math.min(100,Math.round(computeIAJ(stats)*0.7+stats.julgados*0.6));
  setStats(stats);
}
function finishTrial(declararCulpado){
  if(!currentCase) return;
  registrarVeredito(declararCulpado);
  currentCase.status="julgado";
  alert("Veredito registrado. O sistema salvou automaticamente seu progresso.");
  autoSave();
  goTo("office");
}
function backToOffice(){
  if(confirm("Deseja sair da sala de julgamento sem registrar decis√£o?")){
    goTo("office");
  }
}

/* ============ SALVAMENTO / EXPORT ============ */
function getCurrentSave(){
  if(!currentProfile) return null;
  return {
    mode:currentMode,
    court:currentCourt,
    cases:currentCases,
    stats:getStats()
  };
}
function restoreFromSave(save){
  if(!save) return;
  currentMode=save.mode||"carreira";
  currentCourt=save.court||"criminal";
  currentCases=save.cases||[];
  setStats(save.stats||defaultStats());
}
function autoSave(){
  if(!currentProfile) return;
  const s=getCurrentSave();
  profiles[currentProfile].saves.main=s;
  saveProfiles();
}
function manualSave(){
  autoSave();
  alert("Jogo salvo.");
}
function exportCurrentSave(){
  if(!currentProfile){alert("Nenhum perfil ativo.");return;}
  const blob=new Blob([JSON.stringify({profiles:{[currentProfile]:profiles[currentProfile]}},null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download=currentProfile+"_tribunal.juizsave";
  document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
}

/* ============ STJ ============ */
function openStjExam(){
  stjQuestions=[
    {
      q:"No padr√£o 'al√©m de d√∫vida razo√°vel', aplicado aos crimes dolosos contra a vida, qual √© a ideia central?",
      a:[
        "Basta qualquer suspeita para condenar.",
        "√â necess√°rio um grau de certeza elevado, afastando d√∫vidas razo√°veis.",
        "A d√∫vida sempre leva √† condena√ß√£o.",
        "O juiz decide apenas por intui√ß√£o."
      ],
      correct:1
    },
    {
      q:"Na atua√ß√£o de um Ministro do STJ, qual √© o foco principal?",
      a:[
        "Reexaminar provas em todos os detalhes.",
        "Uniformizar a interpreta√ß√£o da legisla√ß√£o federal.",
        "Julgar apenas casos criminais de j√∫ri.",
        "Atuar como juiz eleitoral em primeira inst√¢ncia."
      ],
      correct:1
    },
    {
      q:"Em colegiado, as decis√µes normalmente s√£o tomadas:",
      a:[
        "Por vota√ß√£o entre os Ministros, com proclama√ß√£o do resultado.",
        "Somente pela vontade do Presidente.",
        "Apenas por sorteio.",
        "Sem registro em ac√≥rd√£o."
      ],
      correct:0
    }
  ];
  const box=document.getElementById("stj-questions");
  box.innerHTML="";
  stjQuestions.forEach((q,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.style.marginBottom=".6rem";
    const opts=q.a.map((alt,idx)=>`
      <label style="display:block;font-size:.85rem;margin-top:.3rem;">
        <input type="radio" name="stj-${i}" value="${idx}" style="margin-right:.35rem;" />
        ${String.fromCharCode(65+idx)}) ${alt}
      </label>`).join("");
    div.innerHTML=`<div style="font-size:.9rem;font-weight:600;">${i+1}. ${q.q}</div>${opts}`;
    box.appendChild(div);
  });
  document.getElementById("stj-user-label").textContent="Candidato: "+currentProfile;
  goTo("stj");
}
function cancelStjExam(){
  if(confirm("Deseja cancelar o exame agora?")) goTo("office");
}
function submitStjExam(){
  let score=0;
  stjQuestions.forEach((q,i)=>{
    const checked=document.querySelector(`input[name="stj-${i}"]:checked`);
    if(checked && Number(checked.value)===q.correct) score++;
  });
  const stats=getStats();
  if(score>=2){
    alert("Parab√©ns! Voc√™ foi aprovado no exame simulado do STJ. Seu cargo agora √© Ministro do STJ (simulado).");
    stats.cargo="Ministro do STJ (simulado)";
    stats.stjAtivo=true;
    stats.reputacaoInstitucional = Math.min(100,stats.reputacaoInstitucional+20);
    stats.prestigio=Math.min(100,stats.prestigio+15);
  }else{
    alert("Pontua√ß√£o insuficiente para aprova√ß√£o no exame simulado. Continue estudando e tente novamente.");
    stats.reputacaoInstitucional = Math.max(0,stats.reputacaoInstitucional-3);
  }
  setStats(stats);
  autoSave();
  goTo("office");
}

/* ============ RELAT√ìRIO (exemplo) ============ */
function openReport(){
  const stats=getStats();
  const iaj=computeIAJ(stats);
  document.getElementById("report-user-label").textContent="Juiz: "+currentProfile+" ‚Ä¢ Cargo: "+stats.cargo;
  const div=document.getElementById("report-content");
  div.innerHTML=`
    <p style="font-size:.9rem;color:var(--muted);">
      Este relat√≥rio semestral simulado apresenta um panorama geral do desempenho do magistrado,
      considerando quantidade de casos julgados, ader√™ncia ao gabarito simulado e indicadores de reputa√ß√£o.
    </p>
    <ul style="margin-top:.7rem;margin-left:1.1rem;font-size:.88rem;color:var(--muted);line-height:1.6;">
      <li><strong>Casos julgados:</strong> ${stats.julgados}</li>
      <li><strong>IAJ (ader√™ncia jur√≠dica):</strong> ${iaj}%</li>
      <li><strong>Prest√≠gio geral:</strong> ${stats.prestigio}%</li>
      <li><strong>Reputa√ß√£o p√∫blica:</strong> ${Math.round(stats.reputacaoPublica)}%</li>
      <li><strong>Reputa√ß√£o t√©cnica:</strong> ${Math.round(stats.reputacaoTecnica)}%</li>
      <li><strong>Reputa√ß√£o institucional:</strong> ${Math.round(stats.reputacaoInstitucional)}%</li>
      <li><strong>Cargo atual:</strong> ${stats.cargo}</li>
      <li><strong>STJ ativo:</strong> ${stats.stjAtivo?"Sim":"N√£o"}</li>
    </ul>
    <p style="margin-top:.8rem;font-size:.88rem;color:var(--muted);">
      Professores podem solicitar que os alunos exportem este relat√≥rio juntamente com o arquivo de save
      ao final de cada semestre, para registro qualitativo do progresso.
    </p>`;
  goTo("report");
}

/* ============ INICIALIZA√á√ÉO ============ */
document.addEventListener("keydown",e=>{
  if(currentScreen==="trial"){
    if(e.key==="a" || e.key==="A") speakAccusation();
    if(e.key==="d" || e.key==="D") speakDefense();
    if(e.key==="c" || e.key==="C") finishTrial(true);
    if(e.key==="b" || e.key==="B") finishTrial(false);
    if(e.key==="Enter"){
      e.preventDefault();
      askQuestion();
    }
  }
});
</script>
</body>
</html>
